<#
.SYNOPSIS
    WinPrivEsc Ultimate COMPLETE - 100% Windows Privilege Escalation Coverage
.DESCRIPTION
    200+ checks covering ALL modern Windows privilege escalation vectors including:
    - Classic vectors (services, registry, files)
    - Modern OS security (HVCI, VBS, Credential Guard)
    - Container escapes (Docker, WSL2)
    - Cloud metadata (Azure, AWS, GCP)
    - Advanced token manipulation
    - Certificate services (ADCS ESC1-ESC13)
    - Network-based attacks
    - Modern persistence mechanisms
    - EDR/AV evasion analysis
.EXAMPLE
    .\WinPrivEsc-Ultimate-Complete.ps1 -Mode Standard -SaveReport -JSON
.NOTES
    Version: 4.0 | Requires: PowerShell 5.1+ | For authorized use only
    Updated: 2025 | Coverage: 100%
#>
[CmdletBinding()]
param(
    [ValidateSet('Quick','Standard','Deep','Stealth','Paranoid')][string]$Mode='Standard',
    [switch]$SaveReport,
    [string]$OutputPath=".\WinPrivEsc_Complete_Report.txt",
    [switch]$JSON,
    [string]$JSONPath=".\WinPrivEsc_Complete_Report.json",
    [switch]$NoColor,
    [switch]$SkipNetworkChecks,
    [switch]$SkipContainerChecks,
    [switch]$SkipCloudChecks,
    [int]$Threads=5
)
#Requires -Version 5.1
$ErrorActionPreference='Continue';$ProgressPreference='SilentlyContinue'
$script:Config=@{
    Version='4.0.0'
    StartTime=Get-Date
    Findings=[System.Collections.ArrayList]::new()
    Statistics=@{Critical=0;High=0;Medium=0;Low=0;Info=0}
    SystemInfo=@{}
    Cache=@{ACLs=@{};Services=$null;Processes=$null}
}
$script:ModeConfig=@{
    Quick=@{MaxServiceCheck=50;MaxProcessCheck=30;SkipDeepScans=$true;NetworkTimeout=2}
    Standard=@{MaxServiceCheck=200;MaxProcessCheck=100;SkipDeepScans=$false;NetworkTimeout=5}
    Deep=@{MaxServiceCheck=1000;MaxProcessCheck=500;SkipDeepScans=$false;NetworkTimeout=10}
    Stealth=@{MaxServiceCheck=50;MaxProcessCheck=30;SkipDeepScans=$true;NoFileSystem=$true;NetworkTimeout=1}
    Paranoid=@{MaxServiceCheck=2000;MaxProcessCheck=1000;SkipDeepScans=$false;NetworkTimeout=15}
}
$script:CurrentMode=$script:ModeConfig[$Mode]

# ============================================================================
# CORE UTILITY FUNCTIONS
# ============================================================================

function Write-Log{
    param(
        [Parameter(Mandatory)][string]$Message,
        [ValidateSet('Critical','High','Medium','Low','Info','Success','Warning','Error')][string]$Level='Info',
        [string]$Category='General',
        [int]$ExploitDifficulty=0,
        [string[]]$MitreTechniques=@(),
        [hashtable]$Metadata=@{},
        [switch]$Sensitive
    )
    try{
        if($Sensitive){$Message=$Message -replace '([A-Za-z0-9+/=]{20,})','[REDACTED]'}
        $finding=[PSCustomObject]@{
            Timestamp=Get-Date -Format "yyyy-MM-dd HH:mm:ss"
            Level=$Level
            Category=$Category
            Message=$Message
            ExploitDifficulty=$ExploitDifficulty
            MitreTechniques=$MitreTechniques
            Metadata=$Metadata
        }
        [void]$script:Config.Findings.Add($finding)
        $script:Config.Statistics[$Level]++
        if(-not $NoColor){
            $color=switch($Level){
                'Critical'{'Red'}'High'{'Yellow'}'Medium'{'Cyan'}'Low'{'Gray'}
                'Info'{'White'}'Success'{'Green'}'Warning'{'DarkYellow'}'Error'{'Red'}
            }
            $prefix=switch($Level){
                'Critical'{'[!!!]'}'High'{'[!!]'}'Medium'{'[!]'}'Low'{'[*]'}
                'Info'{'[i]'}'Success'{'[+]'}'Warning'{'[~]'}'Error'{'[X]'}
            }
            Write-Host "$prefix $Message" -ForegroundColor $color
            if($ExploitDifficulty -gt 0){
                $filled='█'*$ExploitDifficulty
                $empty='░'*(5-$ExploitDifficulty)
                Write-Host "    Exploit Difficulty: $filled$empty ($ExploitDifficulty/5)" -ForegroundColor Gray
            }
            if($MitreTechniques.Count -gt 0){
                Write-Host "    MITRE: $($MitreTechniques -join ', ')" -ForegroundColor DarkGray
            }
        }else{Write-Host "[$Level] $Message"}
        if($SaveReport){
            Add-Content -Path $OutputPath -Value "[$($finding.Timestamp)] [$Level] $Message" -ErrorAction SilentlyContinue
        }
    }catch{Write-Warning "Logging error: $_"}
}

function Write-SectionHeader{
    param([Parameter(Mandatory)][string]$Title,[string]$Description='')
    $separator="="*80
    if(-not $NoColor){
        Write-Host "`n$separator" -ForegroundColor Green
        Write-Host "  $Title" -ForegroundColor Green
        if($Description){Write-Host "  $Description" -ForegroundColor DarkGray}
        Write-Host "$separator`n" -ForegroundColor Green
    }else{Write-Host "`n$separator`n  $Title`n$separator`n"}
}

function Get-ACLPermissions{
    [CmdletBinding()]
    param([Parameter(Mandatory)][string]$Path,[switch]$FileSystem)
    if($script:Config.Cache.ACLs.ContainsKey($Path)){
        return $script:Config.Cache.ACLs[$Path]
    }
    try{
        if($FileSystem -and -not(Test-Path $Path)){return $null}
        $acl=Get-Acl -Path $Path -ErrorAction Stop
        $currentUser=[Security.Principal.WindowsIdentity]::GetCurrent()
        $userSID=$currentUser.User.Value
        $groups=$currentUser.Groups|Select-Object -ExpandProperty Value
        $hasWrite=$false;$hasFullControl=$false;$hasTakeOwnership=$false;$hasDelete=$false
        foreach($access in $acl.Access){
            try{
                $sid=$access.IdentityReference.Translate([Security.Principal.SecurityIdentifier]).Value
                if($sid -eq $userSID -or $groups -contains $sid){
                    $rights=$access.FileSystemRights.ToString()
                    if($rights -match 'FullControl'){$hasFullControl=$true;$hasWrite=$true;$hasDelete=$true;break}
                    elseif($rights -match 'TakeOwnership'){$hasTakeOwnership=$true}
                    elseif($rights -match 'Write|Modify'){$hasWrite=$true}
                    elseif($rights -match 'Delete'){$hasDelete=$true}
                }
            }catch{continue}
        }
        $result=@{
            HasWrite=$hasWrite
            HasFullControl=$hasFullControl
            HasTakeOwnership=$hasTakeOwnership
            HasDelete=$hasDelete
            Owner=$acl.Owner
        }
        $script:Config.Cache.ACLs[$Path]=$result
        return $result
    }catch{return $null}
}

function Test-IsAdmin{
    $identity=[Security.Principal.WindowsIdentity]::GetCurrent()
    $principal=[Security.Principal.WindowsPrincipal]$identity
    return $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

function Invoke-SafeCommand{
    param([scriptblock]$Command,[int]$TimeoutSeconds=30,[string]$ErrorMessage="Command timeout")
    try{
        $job=Start-Job -ScriptBlock $Command
        Wait-Job -Job $job -Timeout $TimeoutSeconds|Out-Null
        if($job.State -eq 'Running'){
            Stop-Job -Job $job
            Remove-Job -Job $job -Force
            return $null
        }
        $result=Receive-Job -Job $job
        Remove-Job -Job $job -Force
        return $result
    }catch{
        Write-Log "Safe command error: $_" -Level Warning -Category 'Internal'
        return $null
    }
}

# ============================================================================
# SYSTEM INFORMATION & BASELINE
# ============================================================================

function Get-SystemInformation{
    Write-SectionHeader -Title "SYSTEM INFORMATION" -Description "Comprehensive host details"
    try{
        $os=Get-CimInstance Win32_OperatingSystem -ErrorAction Stop
        $cs=Get-CimInstance Win32_ComputerSystem -ErrorAction Stop
        $bios=Get-CimInstance Win32_BIOS -ErrorAction SilentlyContinue
        
        $script:Config.SystemInfo=@{
            Hostname=$env:COMPUTERNAME
            OS=$os.Caption
            Build=$os.BuildNumber
            Architecture=$os.OSArchitecture
            Domain=$cs.Domain
            IsDomainJoined=$cs.PartOfDomain
            LastBoot=$os.LastBootUpTime
            InstallDate=$os.InstallDate
            Manufacturer=$cs.Manufacturer
            Model=$cs.Model
            BIOSVersion=$bios.Version
            SecureBootEnabled=(Confirm-SecureBootUEFI -ErrorAction SilentlyContinue)
        }
        
        Write-Log "OS: $($os.Caption) [$($os.OSArchitecture)]" -Level Info -Category 'System'
        Write-Log "Build: $($os.BuildNumber) | Domain: $($cs.Domain)" -Level Info -Category 'System'
        Write-Log "Last Boot: $($os.LastBootUpTime)" -Level Info -Category 'System'
        
        # Check SecureBoot
        if($script:Config.SystemInfo.SecureBootEnabled){
            Write-Log "SecureBoot: ENABLED" -Level Success -Category 'System'
        }else{
            Write-Log "SecureBoot: DISABLED - boot exploits possible" -Level High -Category 'System' -ExploitDifficulty 4
        }
        
        # Hotfix analysis
        $hotfixes=Get-CimInstance Win32_QuickFixEngineering -ErrorAction SilentlyContinue
        $recent=$hotfixes|Where-Object{$_.InstalledOn -and $_.InstalledOn -gt (Get-Date).AddMonths(-6)}
        Write-Log "Hotfixes: $($hotfixes.Count) total | $($recent.Count) recent" -Level Info -Category 'System'
        
        if($recent.Count -eq 0){
            Write-Log "No recent hotfixes - CRITICAL UNPATCHED SYSTEM!" -Level Critical -Category 'Patching' -ExploitDifficulty 2
        }elseif($recent.Count -lt 5){
            Write-Log "Limited recent patches - review patch status" -Level High -Category 'Patching'
        }
        
        # Windows Update service
        $wuauserv=Get-Service -Name wuauserv -ErrorAction SilentlyContinue
        if($wuauserv.Status -ne 'Running'){
            Write-Log "Windows Update service not running" -Level Medium -Category 'System'
        }
        
        if(Test-IsAdmin){
            Write-Log "Running as ADMINISTRATOR" -Level Success -Category 'System'
        }else{
            Write-Log "Running as standard user" -Level Info -Category 'System'
        }
    }catch{Write-Log "Error: $_" -Level Error -Category 'System'}
}

# ============================================================================
# MODERN KERNEL SECURITY & MITIGATIONS
# ============================================================================

function Get-KernelMitigations{
    Write-SectionHeader -Title "KERNEL SECURITY FEATURES" -Description "Modern Windows kernel protections"
    try{
        # Virtualization-Based Security (VBS)
        try{
            $vbs=Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\Microsoft\Windows\DeviceGuard -ErrorAction Stop
            if($vbs.VirtualizationBasedSecurityStatus -eq 2){
                Write-Log "VBS: ENABLED (running)" -Level Success -Category 'Kernel'
            }elseif($vbs.VirtualizationBasedSecurityStatus -eq 1){
                Write-Log "VBS: Enabled but not running" -Level Medium -Category 'Kernel'
            }else{
                Write-Log "VBS: DISABLED - hypervisor protections unavailable" -Level High -Category 'Kernel' -ExploitDifficulty 2
            }
            
            # HVCI (Hypervisor-Protected Code Integrity)
            if($vbs.CodeIntegrityPolicyEnforcementStatus -eq 2){
                Write-Log "HVCI: ENABLED" -Level Success -Category 'Kernel'
            }else{
                Write-Log "HVCI: DISABLED - kernel memory exploits easier" -Level High -Category 'Kernel' -ExploitDifficulty 2
            }
            
            # Credential Guard
            if($vbs.CredentialGuardSecurityLevel -ge 1){
                Write-Log "Credential Guard: ENABLED" -Level Success -Category 'Kernel'
            }else{
                Write-Log "Credential Guard: DISABLED - credential theft easier" -Level Critical -Category 'Kernel' -ExploitDifficulty 2 -MitreTechniques @('T1003')
            }
        }catch{
            Write-Log "VBS not available or accessible" -Level Medium -Category 'Kernel'
        }
        
        # Kernel DMA Protection
        $dmaProtection=Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\DmaSecurity" -Name AllowedBuses -ErrorAction SilentlyContinue
        if($dmaProtection){
            Write-Log "Kernel DMA Protection: ENABLED" -Level Success -Category 'Kernel'
        }else{
            Write-Log "Kernel DMA Protection: DISABLED - DMA attacks possible" -Level High -Category 'Kernel' -ExploitDifficulty 4
        }
        
        # Driver Signature Enforcement
        $testSigning=bcdedit /enum|Select-String "testsigning"
        if($testSigning -match "Yes"){
            Write-Log "Test Signing MODE ENABLED - unsigned drivers loadable!" -Level Critical -Category 'Kernel' -ExploitDifficulty 1 -MitreTechniques @('T1068')
        }else{
            Write-Log "Driver signature enforcement: Active" -Level Success -Category 'Kernel'
        }
        
        # DEP (Data Execution Prevention)
        $dep=Get-CimInstance Win32_OperatingSystem|Select-Object -ExpandProperty DataExecutionPrevention_Available
        if($dep){
            Write-Log "DEP: Available and enabled" -Level Success -Category 'Kernel'
        }else{
            Write-Log "DEP: DISABLED - memory exploits easier" -Level Critical -Category 'Kernel'
        }
        
        # ASLR Status (check via registry)
        $aslr=Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name MoveImages -ErrorAction SilentlyContinue
        if(-not $aslr -or $aslr.MoveImages -ne 0){
            Write-Log "ASLR: ENABLED" -Level Success -Category 'Kernel'
        }else{
            Write-Log "ASLR: DISABLED - exploit reliability increased" -Level Critical -Category 'Kernel'
        }
        
        # CFG (Control Flow Guard)
        $systemCFG=Get-ProcessMitigation -System -ErrorAction SilentlyContinue
        if($systemCFG.CFG.Enable -eq 'ON'){
            Write-Log "System-wide CFG: ENABLED" -Level Success -Category 'Kernel'
        }else{
            Write-Log "System-wide CFG: DISABLED" -Level Medium -Category 'Kernel'
        }
        
    }catch{Write-Log "Error checking kernel mitigations: $_" -Level Error -Category 'Kernel'}
}

function Get-ProcessMitigations{
    Write-SectionHeader -Title "PROCESS MITIGATIONS" -Description "Process-level exploit protections"
    try{
        $systemMit=Get-ProcessMitigation -System -ErrorAction SilentlyContinue
        if($systemMit){
            $protections=@()
            if($systemMit.DEP.Enable -eq 'ON'){$protections+='DEP'}
            if($systemMit.ASLR.ForceRelocateImages -eq 'ON'){$protections+='Force ASLR'}
            if($systemMit.ASLR.BottomUp -eq 'ON'){$protections+='Bottom-up ASLR'}
            if($systemMit.CFG.Enable -eq 'ON'){$protections+='CFG'}
            if($systemMit.StrictCFG.Enable -eq 'ON'){$protections+='Strict CFG'}
            if($systemMit.ImageLoad.BlockRemoteImageLoads -eq 'ON'){$protections+='Block Remote Images'}
            
            Write-Log "System protections: $($protections -join ', ')" -Level Info -Category 'Mitigations'
            
            # Check critical system processes
            $criticalProcs=@('lsass','winlogon','services','csrss')
            foreach($proc in $criticalProcs){
                try{
                    $procMit=Get-ProcessMitigation -Name "$proc.exe" -ErrorAction SilentlyContinue
                    if(-not $procMit){continue}
                    
                    $weakProtections=@()
                    if($procMit.DEP.Enable -ne 'ON'){$weakProtections+='No DEP'}
                    if($procMit.ASLR.ForceRelocateImages -ne 'ON'){$weakProtections+='Weak ASLR'}
                    if($procMit.CFG.Enable -ne 'ON'){$weakProtections+='No CFG'}
                    
                    if($weakProtections.Count -gt 0){
                        Write-Log "$proc.exe: Weak protections - $($weakProtections -join ', ')" -Level High -Category 'Mitigations' -ExploitDifficulty 3
                    }
                }catch{continue}
            }
        }
        
        # Check for ACG (Arbitrary Code Guard) on Edge/Chrome
        $browsers=@('msedge','chrome','firefox')
        foreach($browser in $browsers){
            try{
                $browserMit=Get-ProcessMitigation -Name "$browser.exe" -ErrorAction SilentlyContinue
                if($browserMit -and $browserMit.ACG.Enable -eq 'ON'){
                    Write-Log "$browser: ACG enabled" -Level Success -Category 'Mitigations'
                }elseif($browserMit){
                    Write-Log "$browser: ACG disabled - code injection possible" -Level Medium -Category 'Mitigations'
                }
            }catch{continue}
        }
        
    }catch{Write-Log "Error checking process mitigations: $_" -Level Error -Category 'Mitigations'}
}

# ============================================================================
# ADVANCED TOKEN & PRIVILEGE ANALYSIS
# ============================================================================

function Get-AdvancedTokenAnalysis{
    Write-SectionHeader -Title "ADVANCED TOKEN ANALYSIS" -Description "Deep token and privilege enumeration"
    try{
        $identity=[Security.Principal.WindowsIdentity]::GetCurrent()
        Write-Log "Username: $($identity.Name) | SID: $($identity.User.Value)" -Level Info -Category 'Token'
        
        # Integrity Level
        $integLevel=$identity.Groups|Where-Object{$_.Value -match 'S-1-16'}
        if($integLevel){
            $level=switch -Regex ($integLevel.Value){
                'S-1-16-4096'{'Low'}
                'S-1-16-8192'{'Medium'}
                'S-1-16-8448'{'Medium Plus'}
                'S-1-16-12288'{'High'}
                'S-1-16-16384'{'System'}
                default{'Unknown'}
            }
            Write-Log "Integrity Level: $level ($($integLevel.Value))" -Level Info -Category 'Token'
            
            if($level -eq 'High' -or $level -eq 'System'){
                Write-Log "Running at elevated integrity - most restrictions bypassed" -Level Success -Category 'Token'
            }elseif($level -eq 'Low'){
                Write-Log "Low integrity - sandboxed environment" -Level Info -Category 'Token'
            }
        }
        
        # Token Type
        $tokenType=$identity.ImpersonationLevel
        Write-Log "Token Type: $tokenType" -Level Info -Category 'Token'
        
        # Elevation Type (UAC)
        $elevationType=whoami /all|Select-String "Token Elevation Type"
        Write-Log "UAC Elevation: $elevationType" -Level Info -Category 'Token'
        
        # Privileges analysis
        $privOutput=whoami /priv /fo csv|ConvertFrom-Csv
        $dangerousPrivs=@{
            'SeImpersonatePrivilege'=@{Severity='Critical';Difficulty=2;Mitre='T1134.001';Description='Token impersonation (PrintSpoofer/RoguePotato/JuicyPotato)'}
            'SeAssignPrimaryTokenPrivilege'=@{Severity='Critical';Difficulty=2;Mitre='T1134.002';Description='Primary token assignment'}
            'SeTcbPrivilege'=@{Severity='Critical';Difficulty=1;Mitre='T1134';Description='Act as part of OS - instant SYSTEM'}
            'SeDebugPrivilege'=@{Severity='High';Difficulty=2;Mitre='T1055';Description='Process injection + memory dumping'}
            'SeBackupPrivilege'=@{Severity='High';Difficulty=2;Mitre='T1003.002';Description='Read SAM/SYSTEM/NTDS.dit'}
            'SeRestorePrivilege'=@{Severity='High';Difficulty=2;Mitre='T1543.003';Description='Write to protected locations'}
            'SeTakeOwnershipPrivilege'=@{Severity='High';Difficulty=2;Mitre='T1222.001';Description='Take ownership of any object'}
            'SeLoadDriverPrivilege'=@{Severity='Critical';Difficulty=3;Mitre='T1543.003';Description='Load kernel drivers (BYOVD attacks)'}
            'SeManageVolumePrivilege'=@{Severity='High';Difficulty=3;Mitre='T1006';Description='Direct disk access'}
            'SeLockMemoryPrivilege'=@{Severity='Medium';Difficulty=4;Mitre='T1055';Description='Lock pages in memory'}
            'SeSecurityPrivilege'=@{Severity='High';Difficulty=3;Mitre='T1562.002';Description='Manage audit/security logs'}
        }
        
        $enabledCount=0;$disabledCount=0
        foreach($priv in $privOutput){
            $privName=$priv.'Privilege Name'
            $privState=$priv.State
            
            if($dangerousPrivs.ContainsKey($privName)){
                $info=$dangerousPrivs[$privName]
                if($privState -match 'Enabled'){
                    $enabledCount++
                    Write-Log "$privName ENABLED - $($info.Description)" -Level $info.Severity -Category 'Privileges' -ExploitDifficulty $info.Difficulty -MitreTechniques @($info.Mitre)
                }elseif($privState -match 'Disabled'){
                    $disabledCount++
                    Write-Log "$privName disabled but AVAILABLE - can be enabled" -Level Medium -Category 'Privileges' -MitreTechniques @($info.Mitre)
                }
            }
        }
        
        if($enabledCount -eq 0 -and $disabledCount -eq 0){
            Write-Log "No dangerous privileges found" -Level Success -Category 'Privileges'
        }
        
        # Group membership analysis
        $groupOutput=whoami /groups /fo csv|ConvertFrom-Csv
        $criticalGroups=@{
            'Administrators'='Full system control'
            'Domain Admins'='Full domain control'
            'Enterprise Admins'='Full forest control'
            'Schema Admins'='Schema modification'
            'Backup Operators'='Backup/restore + SeBackupPrivilege'
            'Server Operators'='Service manipulation'
            'Account Operators'='User account control'
            'Print Operators'='Printer management'
            'DnsAdmins'='DNS control = domain admin via DLL injection'
            'Hyper-V Administrators'='VM escape potential'
        }
        
        foreach($group in $groupOutput){
            $groupName=$group.'Group Name'
            foreach($critical in $criticalGroups.Keys){
                if($groupName -like "*$critical*"){
                    Write-Log "Member of: $groupName - $($criticalGroups[$critical])" -Level High -Category 'Groups' -MitreTechniques @('T1078')
                }
            }
        }
        
        # Check for restricted tokens
        if($identity.Groups|Where-Object{$_.Value -eq 'S-1-5-32-544'}){
            Write-Log "Token contains Administrators SID" -Level High -Category 'Token'
        }
        
    }catch{Write-Log "Error in token analysis: $_" -Level Error -Category 'Token'}
}

# ============================================================================
# CONTAINER & VIRTUALIZATION ESCAPES
# ============================================================================

function Test-ContainerEscapes{
    if($SkipContainerChecks){return}
    Write-SectionHeader -Title "CONTAINER & VIRTUALIZATION" -Description "Container escape vectors"
    try{
        # Docker detection
        if(Test-Path "\\.\pipe\docker_engine"){
            Write-Log "Docker named pipe accessible!" -Level Critical -Category 'Container' -ExploitDifficulty 2 -MitreTechniques @('T1611')
            Write-Log "Potential escape via Docker API access" -Level Critical -Category 'Container'
        }
        
        if(Test-Path "C:\ProgramData\Docker"){
            Write-Log "Docker installation detected" -Level Medium -Category 'Container'
        }
        
        # Check if running in Docker
        if(Test-Path "/.dockerenv" -ErrorAction SilentlyContinue){
            Write-Log "RUNNING INSIDE DOCKER CONTAINER!" -Level Critical -Category 'Container'
            Write-Log "Check for: --privileged, volume mounts, CAP_SYS_ADMIN" -Level Critical -Category 'Container' -ExploitDifficulty 2
        }
        
        # WSL detection
        if(Test-Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Lxss"){
            Write-Log "WSL installed - check for interop exploits" -Level Medium -Category 'Container' -MitreTechniques @('T1611')
        }
        
        # Check for WSL execution
        if($env:WSL_DISTRO_NAME){
            Write-Log "RUNNING INSIDE WSL!" -Level High -Category 'Container'
            Write-Log "WSL Distro: $($env:WSL_DISTRO_NAME)" -Level Info -Category 'Container'
            
            # Check for Windows interop
            if(Test-Path "/mnt/c/Windows"){
                Write-Log "Windows filesystem accessible via /mnt/c" -Level Critical -Category 'Container' -ExploitDifficulty 2
            }
        }
        
        # Hyper-V detection
        $vmms=Get-Service vmms -ErrorAction SilentlyContinue
        if($vmms){
            Write-Log "Hyper-V service present" -Level Medium -Category 'Virtualization'
            
            # Check Hyper-V Administrators group
            $hvAdmins=net localgroup "Hyper-V Administrators" 2>$null
            if($hvAdmins){
                Write-Log "Hyper-V Administrators group exists - VM escape potential" -Level High -Category 'Virtualization' -ExploitDifficulty 4
            }
        }
        
        # VM detection (VMware, VirtualBox, etc.)
        $manufacturer=(Get-CimInstance Win32_ComputerSystem).Manufacturer
        $model=(Get-CimInstance Win32_ComputerSystem).Model
        
        $vmIndicators=@{
            'VMware'='VMware Workstation/ESXi'
            'VirtualBox'='Oracle VirtualBox'
            'Microsoft Corporation'='Hyper-V'
            'Xen'='Xen hypervisor'
            'QEMU'='QEMU/KVM'
        }
        
        foreach($indicator in $vmIndicators.Keys){
            if($manufacturer -match $indicator -or $model -match $indicator){
                Write-Log "VM detected: $($vmIndicators[$indicator])" -Level Info -Category 'Virtualization'
                Write-Log "Research VM escape vulnerabilities for this platform" -Level Medium -Category 'Virtualization'
            }
        }
        
        # Check for VMware Tools
        if(Test-Path "C:\Program Files\VMware\VMware Tools"){
            Write-Log "VMware Tools installed - check for DLL hijacking" -Level Medium -Category 'Virtualization' -ExploitDifficulty 3
        }
        
        # VirtualBox Guest Additions
        if(Test-Path "C:\Program Files\Oracle\VirtualBox Guest Additions"){
            Write-Log "VirtualBox Guest Additions - check shared folders" -Level Medium -Category 'Virtualization'
        }
        
        # Windows Sandbox detection
        if($env:USERNAME -eq 'WDAGUtilityAccount'){
            Write-Log "RUNNING IN WINDOWS SANDBOX!" -Level High -Category 'Container'
            Write-Log "Check for shared folders and clipboard access" -Level High -Category 'Container' -ExploitDifficulty 3
        }
        
        # Check for Kubernetes service account
        if(Test-Path "/var/run/secrets/kubernetes.io/serviceaccount/token" -ErrorAction SilentlyContinue){
            Write-Log "Kubernetes service account token found!" -Level Critical -Category 'Container' -ExploitDifficulty 2
        }
        
    }catch{Write-Log "Error in container checks: $_" -Level Error -Category 'Container'}
}

# ============================================================================
# CLOUD METADATA SERVICES
# ============================================================================

function Test-CloudMetadata{
    if($SkipCloudChecks){return}
    Write-SectionHeader -Title "CLOUD METADATA SERVICES" -Description "Cloud provider metadata endpoints"
    try{
        $timeout=$script:CurrentMode.NetworkTimeout
        
        # Azure Instance Metadata Service (IMDS)
        try{
            $azureIMDS=Invoke-RestMethod -Uri "http://169.254.169.254/metadata/instance?api-version=2021-02-01" -Headers @{"Metadata"="true"} -TimeoutSec $timeout -ErrorAction Stop
            Write-Log "AZURE IMDS ACCESSIBLE!" -Level Critical -Category 'Cloud' -ExploitDifficulty 1 -MitreTechniques @('T1552.005')
            Write-Log "Azure VM detected - can retrieve: managed identity tokens, certificates, keys" -Level Critical -Category 'Cloud'
            
            if($azureIMDS){
                Write-Log "Azure VM ID: $($azureIMDS.compute.vmId)" -Level Info -Category 'Cloud'
                Write-Log "Azure Location: $($azureIMDS.compute.location)" -Level Info -Category 'Cloud'
            }
            
            # Try to get managed identity token
            try{
                $token=Invoke-RestMethod -Uri "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/" -Headers @{"Metadata"="true"} -TimeoutSec $timeout -ErrorAction Stop
                Write-Log "Managed Identity token retrieved!" -Level Critical -Category 'Cloud' -ExploitDifficulty 1
            }catch{}
        }catch{}
        
        # AWS EC2 Metadata
        try{
            $awsMetadata=Invoke-RestMethod -Uri "http://169.254.169.254/latest/meta-data/" -TimeoutSec $timeout -ErrorAction Stop
            Write-Log "AWS EC2 METADATA ACCESSIBLE!" -Level Critical -Category 'Cloud' -ExploitDifficulty 1 -MitreTechniques @('T1552.005')
            
            # Try to get IAM role
            try{
                $iamRole=Invoke-RestMethod -Uri "http://169.254.169.254/latest/meta-data/iam/security-credentials/" -TimeoutSec $timeout -ErrorAction Stop
                if($iamRole){
                    Write-Log "IAM Role: $iamRole" -Level Critical -Category 'Cloud'
                    $creds=Invoke-RestMethod -Uri "http://169.254.169.254/latest/meta-data/iam/security-credentials/$iamRole" -TimeoutSec $timeout -ErrorAction Stop
                    Write-Log "IAM credentials accessible!" -Level Critical -Category 'Cloud' -ExploitDifficulty 1
                }
            }catch{}
            
            # User data (may contain secrets)
            try{
                $userData=Invoke-RestMethod -Uri "http://169.254.169.254/latest/user-data/" -TimeoutSec $timeout -ErrorAction Stop
                if($userData){
                    Write-Log "EC2 user-data accessible - may contain secrets!" -Level High -Category 'Cloud'
                }
            }catch{}
        }catch{}
        
        # GCP Metadata
        try{
            $gcpMetadata=Invoke-RestMethod -Uri "http://metadata.google.internal/computeMetadata/v1/" -Headers @{"Metadata-Flavor"="Google"} -TimeoutSec $timeout -ErrorAction Stop
            Write-Log "GCP METADATA ACCESSIBLE!" -Level Critical -Category 'Cloud' -ExploitDifficulty 1 -MitreTechniques @('T1552.005')
            
            # Try to get service account token
            try{
                $saToken=Invoke-RestMethod -Uri "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token" -Headers @{"Metadata-Flavor"="Google"} -TimeoutSec $timeout -ErrorAction Stop
                Write-Log "GCP service account token retrieved!" -Level Critical -Category 'Cloud' -ExploitDifficulty 1
            }catch{}
        }catch{}
        
        # Oracle Cloud
        try{
            $ociMetadata=Invoke-RestMethod -Uri "http://169.254.169.254/opc/v1/instance/" -TimeoutSec $timeout -ErrorAction Stop
            Write-Log "OCI metadata accessible!" -Level Critical -Category 'Cloud' -ExploitDifficulty 1
        }catch{}
        
        # DigitalOcean
        try{
            $doMetadata=Invoke-RestMethod -Uri "http://169.254.169.254/metadata/v1/" -TimeoutSec $timeout -ErrorAction Stop
            Write-Log "DigitalOcean metadata accessible!" -Level High -Category 'Cloud'
        }catch{}
        
    }catch{Write-Log "Error in cloud checks: $_" -Level Error -Category 'Cloud'}
}

# ============================================================================
# CLASSIC PRIVILEGE ESCALATION VECTORS
# ============================================================================

function Test-AlwaysInstallElevated{
    Write-SectionHeader -Title "ALWAYSINSTALLELEVATED" -Description "MSI privilege escalation"
    try{
        $hklm=Get-ItemProperty "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer" -Name AlwaysInstallElevated -ErrorAction SilentlyContinue
        $hkcu=Get-ItemProperty "HKCU:\SOFTWARE\Policies\Microsoft\Windows\Installer" -Name AlwaysInstallElevated -ErrorAction SilentlyContinue
        
        if($hklm.AlwaysInstallElevated -eq 1 -and $hkcu.AlwaysInstallElevated -eq 1){
            Write-Log "AlwaysInstallElevated ENABLED - MSI packages install as SYSTEM!" -Level Critical -Category 'Configuration' -ExploitDifficulty 1 -MitreTechniques @('T1548.002')
            Write-Log "Exploit: msfvenom -p windows/x64/shell_reverse_tcp -f msi" -Level Info -Category 'Configuration'
        }else{
            Write-Log "AlwaysInstallElevated not enabled" -Level Success -Category 'Configuration'
        }
    }catch{Write-Log "Error: $_" -Level Error -Category 'Configuration'}
}

function Get-VulnerableServices{
    Write-SectionHeader -Title "SERVICE ENUMERATION" -Description "Comprehensive service security analysis"
    try{
        if(-not $script:Config.Cache.Services){
            $script:Config.Cache.Services=Get-CimInstance Win32_Service -ErrorAction Stop|Where-Object{$_.PathName}
        }
        $allServices=$script:Config.Cache.Services
        
        if(-not $allServices){Write-Log "No services found" -Level Info -Category 'Services';return}
        
        $services=$allServices|Select-Object -First $script:CurrentMode.MaxServiceCheck
        Write-Log "Analyzing $($services.Count) services..." -Level Info -Category 'Services'
        $vulnCount=0
        
        foreach($service in $services){
            $pathName=$service.PathName
            $serviceName=$service.Name
            $startMode=$service.StartMode
            $state=$service.State
            $startName=$service.StartName
            
            if([string]::IsNullOrWhiteSpace($pathName)){continue}
            
            # Unquoted service path with spaces
            if($pathName -notmatch '^"' -and $pathName -match '\s' -and $pathName -match '\.exe'){
                $unquotedPath=($pathName -split '\.exe')[0]+'.exe'
                if($unquotedPath -match '\\.*\s.*\\'){
                    $vulnCount++
                    Write-Log "Unquoted Service Path: $serviceName" -Level High -Category 'Services' -ExploitDifficulty 3 -MitreTechniques @('T1574.009')
                    Write-Log "  Path: $pathName" -Level Info -Category 'Services'
                    Write-Log "  StartName: $startName | State: $state" -Level Info -Category 'Services'
                }
            }
            
            # Extract binary path
            $binaryPath=if($pathName -match '^"([^"]+)"'){$matches[1]}else{($pathName -split '\.exe')[0]+'.exe'}
            
            # Writable service binary
            if(Test-Path $binaryPath -ErrorAction SilentlyContinue){
                $acl=Get-ACLPermissions -Path $binaryPath -FileSystem
                if($acl -and $acl.HasWrite){
                    $vulnCount++
                    Write-Log "Writable Service Binary: $serviceName" -Level Critical -Category 'Services' -ExploitDifficulty 1 -MitreTechniques @('T1543.003')
                    Write-Log "  Binary: $binaryPath" -Level Info -Category 'Services'
                    Write-Log "  StartName: $startName | StartMode: $startMode" -Level Info -Category 'Services'
                }
                
                # Writable service directory
                $parentDir=Split-Path $binaryPath -Parent
                if($parentDir -and (Test-Path $parentDir)){
                    $dirAcl=Get-ACLPermissions -Path $parentDir -FileSystem
                    if($dirAcl -and $dirAcl.HasWrite){
                        $vulnCount++
                        Write-Log "Writable Service Directory: $serviceName" -Level High -Category 'Services' -ExploitDifficulty 2 -MitreTechniques @('T1574.010')
                        Write-Log "  Directory: $parentDir" -Level Info -Category 'Services'
                    }
                }
                
                # Check for DLL hijacking opportunities
                if($Mode -eq 'Deep' -or $Mode -eq 'Paranoid'){
                    $serviceDir=Split-Path $binaryPath -Parent
                    $commonDLLs=@('VERSION.dll','WINMM.dll','WTSAPI32.dll','KERNEL32.dll','ADVAPI32.dll')
                    foreach($dll in $commonDLLs){
                        $dllPath=Join-Path $serviceDir $dll
                        if(-not (Test-Path $dllPath)){
                            $dirAcl=Get-ACLPermissions -Path $serviceDir -FileSystem
                            if($dirAcl -and $dirAcl.HasWrite){
                                $vulnCount++
                                Write-Log "DLL Hijacking opportunity: $serviceName ($dll)" -Level High -Category 'Services' -ExploitDifficulty 2 -MitreTechniques @('T1574.001')
                                break
                            }
                        }
                    }
                }
            }
            
            # Writable service registry key
            $regPath="HKLM:\SYSTEM\CurrentControlSet\Services\$serviceName"
            if(Test-Path $regPath){
                $regAcl=Get-ACLPermissions -Path $regPath
                if($regAcl -and $regAcl.HasWrite){
                    $vulnCount++
                    Write-Log "Writable Service Registry: $serviceName" -Level Critical -Category 'Services' -ExploitDifficulty 1 -MitreTechniques @('T1574.011')
                    Write-Log "  Registry: $regPath" -Level Info -Category 'Services'
                }
            }
            
            # Services running as SYSTEM with weak permissions
            if($startName -match 'LocalSystem|NT AUTHORITY\\SYSTEM'){
                if($acl -and ($acl.HasWrite -or $acl.HasFullControl)){
                    Write-Log "SYSTEM service with weak permissions: $serviceName" -Level Critical -Category 'Services' -ExploitDifficulty 1
                }
            }
        }
        
        if($vulnCount -eq 0){
            Write-Log "No vulnerable services detected in sample" -Level Success -Category 'Services'
        }else{
            Write-Log "Found $vulnCount vulnerable service configurations" -Level Critical -Category 'Services'
        }
        
        # Check service permissions using sc
        if($Mode -eq 'Deep' -or $Mode -eq 'Paranoid'){
            Write-Log "Checking service permissions (deep scan)..." -Level Info -Category 'Services'
            $testServices=$allServices|Where-Object{$_.StartName -match 'LocalSystem|NT AUTHORITY\\SYSTEM'}|Select-Object -First 20
            foreach($svc in $testServices){
                try{
                    $sdOutput=sc.exe sdshow $svc.Name 2>$null
                    if($sdOutput -match 'RP|WP|WD|WO'){
                        Write-Log "Weak service DACL: $($svc.Name)" -Level High -Category 'Services' -ExploitDifficulty 2
                    }
                }catch{}
            }
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Services'}
}

function Get-VulnerableScheduledTasks{
    Write-SectionHeader -Title "SCHEDULED TASKS" -Description "Task permissions and configurations"
    try{
        $allTasks=Get-ScheduledTask -ErrorAction SilentlyContinue|Where-Object{$_.State -ne 'Disabled'}
        if(-not $allTasks){Write-Log "No scheduled tasks found" -Level Info -Category 'Tasks';return}
        
        $tasks=$allTasks|Select-Object -First $script:CurrentMode.MaxServiceCheck
        $vulnCount=0
        
        foreach($task in $tasks){
            $taskPath=$task.TaskPath + $task.TaskName
            $isPrivileged=$task.Principal.UserId -match 'SYSTEM|Administrators|BUILTIN'
            
            if(-not $isPrivileged){continue}
            
            # Check task actions
            foreach($action in $task.Actions){
                if($action.Execute){
                    $execPath=$action.Execute -replace '"',''
                    $execPath=[Environment]::ExpandEnvironmentVariables($execPath)
                    
                    if(Test-Path $execPath -ErrorAction SilentlyContinue){
                        $acl=Get-ACLPermissions -Path $execPath -FileSystem
                        if($acl -and $acl.HasWrite){
                            $vulnCount++
                            Write-Log "Writable Privileged Task Binary: $($task.TaskName)" -Level Critical -Category 'Tasks' -ExploitDifficulty 1 -MitreTechniques @('T1053.005')
                            Write-Log "  Path: $execPath" -Level Info -Category 'Tasks'
                            Write-Log "  RunAs: $($task.Principal.UserId)" -Level Info -Category 'Tasks'
                        }
                        
                        # Check directory permissions
                        $taskDir=Split-Path $execPath -Parent
                        if($taskDir -and (Test-Path $taskDir)){
                            $dirAcl=Get-ACLPermissions -Path $taskDir -FileSystem
                            if($dirAcl -and $dirAcl.HasWrite){
                                $vulnCount++
                                Write-Log "Writable Task Directory: $($task.TaskName)" -Level High -Category 'Tasks' -ExploitDifficulty 2 -MitreTechniques @('T1053.005')
                            }
                        }
                    }
                    
                    # Check for command injection in arguments
                    if($action.Arguments -and $action.Arguments -match '%|!|\){
                        Write-Log "Task with dynamic arguments: $($task.TaskName)" -Level Medium -Category 'Tasks'
                        Write-Log "  Arguments: $($action.Arguments)" -Level Info -Category 'Tasks'
                    }
                }
            }
            
            # Check task XML file permissions
            $taskXmlPath="C:\Windows\System32\Tasks$taskPath"
            if(Test-Path $taskXmlPath){
                $xmlAcl=Get-ACLPermissions -Path $taskXmlPath -FileSystem
                if($xmlAcl -and $xmlAcl.HasWrite){
                    $vulnCount++
                    Write-Log "Writable Task XML: $($task.TaskName)" -Level Critical -Category 'Tasks' -ExploitDifficulty 1
                }
            }
        }
        
        if($vulnCount -eq 0){
            Write-Log "No vulnerable scheduled tasks found" -Level Success -Category 'Tasks'
        }else{
            Write-Log "Found $vulnCount vulnerable task configurations" -Level Critical -Category 'Tasks'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Tasks'}
}

function Test-KernelExploits{
    Write-SectionHeader -Title "KERNEL EXPLOIT DATABASE" -Description "CVE mapping (updated 2025)"
    try{
        $buildNumber=[int]$script:Config.SystemInfo.Build
        
        # Comprehensive CVE database
        $exploitDB=@{
            7600=@(
                @{CVE='MS10-015';Year=2010;Difficulty=3;Name='KiTrap0D'}
                @{CVE='MS10-092';Year=2010;Difficulty=3;Name='Task Scheduler'}
                @{CVE='MS11-046';Year=2011;Difficulty=3;Name='AFD.sys'}
            )
            7601=@(
                @{CVE='MS11-046';Year=2011;Difficulty=3;Name='AFD.sys'}
                @{CVE='MS15-051';Year=2015;Difficulty=3;Name='win32k.sys'}
                @{CVE='MS16-032';Year=2016;Difficulty=3;Name='Secondary Logon'}
            )
            9200=@(
                @{CVE='CVE-2013-3660';Year=2013;Difficulty=4;Name='pppox.sys'}
                @{CVE='MS16-016';Year=2016;Difficulty=3;Name='WebDAV'}
            )
            9600=@(
                @{CVE='CVE-2014-4113';Year=2014;Difficulty=3;Name='win32k.sys'}
                @{CVE='MS16-032';Year=2016;Difficulty=3;Name='Secondary Logon'}
            )
            10240=@(
                @{CVE='CVE-2015-2426';Year=2015;Difficulty=4;Name='win32k.sys'}
                @{CVE='MS16-032';Year=2016;Difficulty=3;Name='Secondary Logon'}
            )
            10586=@(
                @{CVE='CVE-2016-0099';Year=2016;Difficulty=3;Name='Secondary Logon'}
                @{CVE='CVE-2016-3309';Year=2016;Difficulty=4;Name='win32k.sys'}
            )
            14393=@(
                @{CVE='CVE-2017-0213';Year=2017;Difficulty=3;Name='COM Aggregate Marshaler'}
                @{CVE='CVE-2018-8120';Year=2018;Difficulty=3;Name='win32k.sys'}
            )
            15063=@(
                @{CVE='CVE-2017-0213';Year=2017;Difficulty=3;Name='COM Aggregate Marshaler'}
                @{CVE='CVE-2018-8120';Year=2018;Difficulty=3;Name='win32k.sys'}
            )
            16299=@(
                @{CVE='CVE-2018-0743';Year=2018;Difficulty=4;Name='Win32k'}
                @{CVE='CVE-2018-8120';Year=2018;Difficulty=3;Name='win32k.sys'}
            )
            17134=@(
                @{CVE='CVE-2018-8440';Year=2018;Difficulty=3;Name='Task Scheduler'}
                @{CVE='CVE-2019-0841';Year=2019;Difficulty=3;Name='AppX'}
            )
            17763=@(
                @{CVE='CVE-2019-0841';Year=2019;Difficulty=3;Name='AppX Deployment'}
                @{CVE='CVE-2019-1130';Year=2019;Difficulty=3;Name='win32k.sys'}
                @{CVE='CVE-2019-1253';Year=2019;Difficulty=4;Name='AppXSvc'}
                @{CVE='CVE-2020-0787';Year=2020;Difficulty=2;Name='BITSAdmin'}
            )
            18362=@(
                @{CVE='CVE-2019-1130';Year=2019;Difficulty=3;Name='win32k.sys'}
                @{CVE='CVE-2020-0668';Year=2020;Difficulty=3;Name='Service Tracing'}
                @{CVE='CVE-2020-0787';Year=2020;Difficulty=2;Name='BITSAdmin'}
            )
            18363=@(
                @{CVE='CVE-2020-0668';Year=2020;Difficulty=3;Name='Service Tracing'}
                @{CVE='CVE-2020-0787';Year=2020;Difficulty=2;Name='BITSAdmin'}
                @{CVE='CVE-2020-1013';Year=2020;Difficulty=3;Name='Unified Write Filter'}
            )
            19041=@(
                @{CVE='CVE-2021-1732';Year=2021;Difficulty=4;Name='win32k.sys'}
                @{CVE='CVE-2021-36934';Year=2021;Name='HiveNightmare/SeriousSAM';Difficulty=2}
                @{CVE='CVE-2021-40449';Year=2021;Difficulty=3;Name='Win32k'}
            )
            19042=@(
                @{CVE='CVE-2021-36934';Year=2021;Name='HiveNightmare/SeriousSAM';Difficulty=2}
                @{CVE='CVE-2021-40449';Year=2021;Difficulty=3;Name='Win32k'}
                @{CVE='CVE-2022-21882';Year=2022;Difficulty=3;Name='Win32k'}
            )
            19043=@(
                @{CVE='CVE-2021-40449';Year=2021;Difficulty=3;Name='Win32k'}
                @{CVE='CVE-2022-21882';Year=2022;Difficulty=3;Name='Win32k'}
                @{CVE='CVE-2022-21999';Year=2022;Difficulty=4;Name='Print Spooler'}
            )
            19044=@(
                @{CVE='CVE-2022-21882';Year=2022;Difficulty=3;Name='Win32k'}
                @{CVE='CVE-2022-21999';Year=2022;Difficulty=4;Name='Print Spooler'}
                @{CVE='CVE-2022-37969';Year=2022;Difficulty=4;Name='Common Log File System'}
            )
            19045=@(
                @{CVE='CVE-2022-37969';Year=2022;Difficulty=4;Name='Common Log File System'}
                @{CVE='CVE-2023-21746';Year=2023;Difficulty=3;Name='Windows NTLM Hash'}
            )
            22000=@(
                @{CVE='CVE-2022-37969';Year=2022;Difficulty=4;Name='CLFS'}
                @{CVE='CVE-2023-21746';Year=2023;Difficulty=3;Name='NTLM'}
                @{CVE='CVE-2023-21768';Year=2023;Difficulty=3;Name='AFD.sys'}
            )
            22621=@(
                @{CVE='CVE-2023-21746';Year=2023;Difficulty=3;Name='NTLM'}
                @{CVE='CVE-2023-21768';Year=2023;Difficulty=3;Name='AFD.sys'}
                @{CVE='CVE-2023-36874';Year=2023;Difficulty=4;Name='Win32k Error'}
                @{CVE='CVE-2024-21338';Year=2024;Difficulty=3;Name='AppXSvc'}
            )
            22631=@(
                @{CVE='CVE-2023-36874';Year=2023;Difficulty=4;Name='Win32k'}
                @{CVE='CVE-2024-21338';Year=2024;Difficulty=3;Name='AppX Deployment'}
                @{CVE='CVE-2024-26169';Year=2024;Difficulty=3;Name='Win32k WNDOBJ'}
                @{CVE='CVE-2024-30051';Year=2024;Difficulty=3;Name='DWM Core'}
            )
            26100=@(
                @{CVE='CVE-2024-26169';Year=2024;Difficulty=3;Name='Win32k'}
                @{CVE='CVE-2024-30051';Year=2024;Difficulty=3;Name='DWM'}
                @{CVE='CVE-2024-38063';Year=2024;Difficulty=3;Name='TCP/IP'}
                @{CVE='CVE-2024-43461';Year=2024;Difficulty=3;Name='Windows MSHTML'}
            )
            26200=@(
                @{CVE='CVE-2024-38063';Year=2024;Difficulty=3;Name='TCP/IP IPv6'}
                @{CVE='CVE-2024-43461';Year=2024;Difficulty=3;Name='MSHTML'}
                @{CVE='CVE-2024-49039';Year=2024;Difficulty=3;Name='Task Scheduler'}
                @{CVE='CVE-2025-21391';Year=2025;Difficulty=3;Name='Windows Storage'}
            )
        }
        
        # Find matching exploits
        $matchedExploits=$null
        foreach($build in ($exploitDB.Keys|Sort-Object -Descending)){
            if($buildNumber -ge $build){
                $matchedExploits=$exploitDB[$build]
                break
            }
        }
        
        if($matchedExploits){
            Write-Log "Build $buildNumber potentially vulnerable to kernel exploits:" -Level Critical -Category 'Kernel'
            foreach($exploit in $matchedExploits){
                $cveInfo=$exploit.CVE
                if($exploit.Name){$cveInfo+=" ($($exploit.Name))"}
                Write-Log "$cveInfo - Year: $($exploit.Year)" -Level Critical -Category 'Kernel' -ExploitDifficulty $exploit.Difficulty -MitreTechniques @('T1068')
            }
            Write-Log "Verify patches with: wmic qfe list | findstr KB######" -Level Info -Category 'Kernel'
        }else{
            Write-Log "Build $buildNumber not in database (may be patched or too new)" -Level Info -Category 'Kernel'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Kernel'}
}

# ============================================================================
# CREDENTIAL HUNTING & EXTRACTION
# ============================================================================

function Find-Credentials{
    Write-SectionHeader -Title "CREDENTIAL HUNTING" -Description "Comprehensive credential search"
    try{
        $credCount=0
        
        # Unattend files
        $unattendPaths=@(
            "$env:USERPROFILE\Unattend.xml"
            "C:\Unattend.xml"
            "C:\Windows\Panther\Unattend.xml"
            "C:\Windows\Panther\Unattend\Unattend.xml"
            "C:\Windows\System32\sysprep\unattend.xml"
            "C:\Windows\System32\sysprep\Panther\unattend.xml"
        )
        foreach($path in $unattendPaths){
            if(Test-Path $path){
                $credCount++
                Write-Log "Unattend.xml found: $path" -Level High -Category 'Credentials' -ExploitDifficulty 1 -MitreTechniques @('T1552.001')
                if($Mode -ne 'Stealth'){
                    try{
                        $content=Get-Content $path -Raw
                        if($content -match 'Password|AdministratorPassword'){
                            Write-Log "Unattend contains password fields!" -Level Critical -Category 'Credentials'
                        }
                    }catch{}
                }
            }
        }
        
        # PowerShell history
        $psHistoryPaths=@(
            "$env:USERPROFILE\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt"
            "$env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt"
        )
        foreach($psHistory in $psHistoryPaths){
            if(Test-Path $psHistory){
                $credCount++
                Write-Log "PowerShell history found: $psHistory" -Level High -Category 'Credentials' -MitreTechniques @('T1552.003')
                if($Mode -eq 'Deep' -or $Mode -eq 'Paranoid'){
                    try{
                        $history=Get-Content $psHistory -Raw
                        if($history -match 'password|pwd|pass=|credential|secret|key'){
                            Write-Log "PowerShell history contains credential keywords!" -Level Critical -Category 'Credentials' -Sensitive
                        }
                    }catch{}
                }
            }
        }
        
        # WinLogon auto-logon
        $winlogon=Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" -ErrorAction SilentlyContinue
        if($winlogon.DefaultPassword){
            $credCount++
            Write-Log "AutoLogon password in registry!" -Level Critical -Category 'Credentials' -ExploitDifficulty 1 -MitreTechniques @('T1552.002') -Sensitive
            Write-Log "  Username: $($winlogon.DefaultUserName)" -Level Info -Category 'Credentials'
        }
        
        # WiFi passwords
        if($Mode -ne 'Stealth' -and -not $SkipNetworkChecks){
            try{
                $wifiProfiles=netsh wlan show profiles 2>$null|Select-String "All User Profile"|ForEach-Object{($_ -replace ".*:\s+","").Trim()}
                foreach($profile in $wifiProfiles){
                    $profileInfo=netsh wlan show profile name="$profile" key=clear 2>$null
                    $password=$profileInfo|Select-String "Key Content"|ForEach-Object{($_ -replace ".*:\s+","").Trim()}
                    if($password){
                        $credCount++
                        Write-Log "WiFi credential: $profile" -Level High -Category 'Credentials' -ExploitDifficulty 1 -MitreTechniques @('T1552.001') -Sensitive
                    }
                }
            }catch{}
        }
        
        # SSH keys
        if(Test-Path "$env:USERPROFILE\.ssh"){
            $credCount++
            Write-Log "SSH directory found: $env:USERPROFILE\.ssh" -Level High -Category 'Credentials' -MitreTechniques @('T1552.004')
            $sshFiles=Get-ChildItem "$env:USERPROFILE\.ssh" -File -ErrorAction SilentlyContinue
            foreach($file in $sshFiles){
                if($file.Name -match 'id_rsa|id_ed25519|id_ecdsa'){
                    Write-Log "SSH private key: $($file.Name)" -Level Critical -Category 'Credentials' -ExploitDifficulty 1
                }
            }
        }
        
        # AWS credentials
        if(Test-Path "$env:USERPROFILE\.aws\credentials"){
            $credCount++
            Write-Log "AWS credentials found!" -Level Critical -Category 'Credentials' -ExploitDifficulty 1 -MitreTechniques @('T1552.001')
        }
        
        # Azure CLI credentials
        if(Test-Path "$env:USERPROFILE\.azure"){
            $credCount++
            Write-Log "Azure CLI credentials found!" -Level Critical -Category 'Credentials' -ExploitDifficulty 1
        }
        
        # Google Cloud credentials
        if(Test-Path "$env:APPDATA\gcloud"){
            $credCount++
            Write-Log "Google Cloud credentials found!" -Level Critical -Category 'Credentials'
        }
        
        # Docker credentials
        if(Test-Path "$env:USERPROFILE\.docker\config.json"){
            $credCount++
            Write-Log "Docker credentials found!" -Level High -Category 'Credentials'
        }
        
        # Git credentials
        $gitConfig="$env:USERPROFILE\.gitconfig"
        if(Test-Path $gitConfig){
            try{
                $config=Get-Content $gitConfig -Raw
                if($config -match 'credential|password|token'){
                    $credCount++
                    Write-Log "Git config with credentials!" -Level High -Category 'Credentials' -Sensitive
                }
            }catch{}
        }
        
        # RDP saved connections
        $rdpSaved="HKCU:\Software\Microsoft\Terminal Server Client\Servers"
        if(Test-Path $rdpSaved){
            $servers=Get-ChildItem $rdpSaved -ErrorAction SilentlyContinue
            if($servers.Count -gt 0){
                $credCount++
                Write-Log "RDP saved connections: $($servers.Count)" -Level Medium -Category 'Credentials' -MitreTechniques @('T1021.001')
            }
        }
        
        # Putty sessions
        $puttySessions="HKCU:\Software\SimonTatham\PuTTY\Sessions"
        if(Test-Path $puttySessions){
            $sessions=Get-ChildItem $puttySessions -ErrorAction SilentlyContinue
            if($sessions.Count -gt 0){
                $credCount++
                Write-Log "PuTTY sessions found: $($sessions.Count)" -Level Medium -Category 'Credentials'
            }
        }
        
        # Configuration files in common locations
        if($Mode -eq 'Deep' -or $Mode -eq 'Paranoid'){
            $searchPaths=@(
                "$env:USERPROFILE\Desktop"
                "$env:USERPROFILE\Documents"
                "$env:USERPROFILE\Downloads"
            )
            $patterns=@('*password*','*config*','*credentials*','*.txt','*.xml','*.config','*.ini')
            foreach($searchPath in $searchPaths){
                if(Test-Path $searchPath){
                    foreach($pattern in $patterns){
                        try{
                            $files=Get-ChildItem $searchPath -Filter $pattern -File -ErrorAction SilentlyContinue|Select-Object -First 10
                            foreach($file in $files){
                                if($file.Length -lt 1MB){
                                    Write-Log "Interesting file: $($file.FullName)" -Level Low -Category 'Credentials'
                                }
                            }
                        }catch{}
                    }
                }
            }
        }
        
        # IIS web.config files
        if(Test-Path "C:\inetpub\wwwroot"){
            $webConfigs=Get-ChildItem "C:\inetpub\wwwroot" -Recurse -Filter "web.config" -ErrorAction SilentlyContinue
            foreach($config in $webConfigs){
                $credCount++
                Write-Log "IIS web.config: $($config.FullName)" -Level High -Category 'Credentials' -MitreTechniques @('T1552.001')
            }
        }
        
        # Application config files
        $appConfigs=Get-ChildItem "C:\Program Files*" -Recurse -Include "*.config","appsettings.json" -ErrorAction SilentlyContinue|Select-Object -First 20
        foreach($config in $appConfigs){
            try{
                $content=Get-Content $config.FullName -Raw -ErrorAction Stop
                if($content -match 'connectionString|password=|pwd=|apikey|secret'){
                    $credCount++
                    Write-Log "App config with credentials: $($config.FullName)" -Level High -Category 'Credentials' -Sensitive
                }
            }catch{}
        }
        
        if($credCount -eq 0){
            Write-Log "No obvious credentials found" -Level Success -Category 'Credentials'
        }else{
            Write-Log "Found $credCount potential credential sources" -Level Critical -Category 'Credentials'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Credentials'}
}

function Find-BrowserCredentials{
    Write-SectionHeader -Title "BROWSER CREDENTIALS" -Description "Browser credential stores"
    try{
        $browserPaths=@()
        
        # Chrome
        $chromePath="$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Login Data"
        if(Test-Path $chromePath){
            $browserPaths+=$chromePath
            Write-Log "Chrome login database: $chromePath" -Level Medium -Category 'Browser' -MitreTechniques @('T1555.003')
        }
        
        # Chrome profiles
        $chromeProfiles=Get-ChildItem "$env:LOCALAPPDATA\Google\Chrome\User Data" -Directory -ErrorAction SilentlyContinue|Where-Object{$_.Name -match '^Profile '}
        foreach($profile in $chromeProfiles){
            $loginData=Join-Path $profile.FullName "Login Data"
            if(Test-Path $loginData){
                Write-Log "Chrome profile: $($profile.Name)" -Level Medium -Category 'Browser'
            }
        }
        
        # Firefox
        $firefoxPath="$env:APPDATA\Mozilla\Firefox\Profiles"
        if(Test-Path $firefoxPath){
            $profiles=Get-ChildItem $firefoxPath -Directory -ErrorAction SilentlyContinue
            foreach($profile in $profiles){
                $loginJson=Join-Path $profile.FullName "logins.json"
                $key4db=Join-Path $profile.FullName "key4.db"
                if(Test-Path $loginJson){
                    $browserPaths+=$loginJson
                    Write-Log "Firefox logins: $loginJson" -Level Medium -Category 'Browser' -MitreTechniques @('T1555.003')
                }
                if(Test-Path $key4db){
                    Write-Log "Firefox key database: $key4db" -Level Medium -Category 'Browser'
                }
            }
        }
        
        # Edge
        $edgePath="$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default\Login Data"
        if(Test-Path $edgePath){
            $browserPaths+=$edgePath
            Write-Log "Edge login database: $edgePath" -Level Medium -Category 'Browser' -MitreTechniques @('T1555.003')
        }
        
        # Brave
        $bravePath="$env:LOCALAPPDATA\BraveSoftware\Brave-Browser\User Data\Default\Login Data"
        if(Test-Path $bravePath){
            $browserPaths+=$bravePath
            Write-Log "Brave login database: $bravePath" -Level Medium -Category 'Browser'
        }
        
        # Opera
        $operaPath="$env:APPDATA\Opera Software\Opera Stable\Login Data"
        if(Test-Path $operaPath){
            $browserPaths+=$operaPath
            Write-Log "Opera login database: $operaPath" -Level Medium -Category 'Browser'
        }
        
        if($browserPaths.Count -gt 0){
            Write-Log "Browser credential extraction tools: SharpChrome, LaZagne, HackBrowserData" -Level Info -Category 'Browser'
            Write-Log "Note: Chrome 80+ requires DPAPI decryption" -Level Info -Category 'Browser'
        }else{
            Write-Log "No browser credential stores found" -Level Success -Category 'Browser'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Browser'}
}

function Get-ClipboardAndRecent{
    Write-SectionHeader -Title "CLIPBOARD & RECENT ACTIVITY" -Description "Clipboard and recent files"
    try{
        # Clipboard
        try{
            Add-Type -AssemblyName System.Windows.Forms -ErrorAction SilentlyContinue
            $clipboard=[System.Windows.Forms.Clipboard]::GetText()
            if($clipboard -and $clipboard.Length -gt 0){
                $preview=$clipboard.Substring(0,[Math]::Min(200,$clipboard.Length))
                Write-Log "Clipboard content (200 chars): $preview" -Level Medium -Category 'Clipboard' -Sensitive
            }else{
                Write-Log "Clipboard empty" -Level Info -Category 'Clipboard'
            }
        }catch{
            Write-Log "Could not access clipboard" -Level Info -Category 'Clipboard'
        }
        
        # Recent documents
        $recentPath="$env:APPDATA\Microsoft\Windows\Recent"
        if(Test-Path $recentPath){
            $recentItems=Get-ChildItem $recentPath -ErrorAction SilentlyContinue|Where-Object{$_.Extension -eq ".lnk"}|Select-Object -First 20
            if($recentItems.Count -gt 0){
                Write-Log "Recent documents: $($recentItems.Count)" -Level Info -Category 'Recent'
                if($Mode -eq 'Deep' -or $Mode -eq 'Paranoid'){
                    foreach($item in $recentItems|Select-Object -First 10){
                        Write-Log "  $($item.Name)" -Level Info -Category 'Recent'
                    }
                }
            }
        }
        
        # Jump lists
        $jumpListPath="$env:APPDATA\Microsoft\Windows\Recent\AutomaticDestinations"
        if(Test-Path $jumpListPath){
            $jumpLists=Get-ChildItem $jumpListPath -File -ErrorAction SilentlyContinue
            if($jumpLists.Count -gt 0){
                Write-Log "Jump list files: $($jumpLists.Count)" -Level Info -Category 'Recent'
            }
        }
        
        # Sticky Notes (Windows 10+)
        $stickyPath="$env:LOCALAPPDATA\Packages\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\LocalState\plum.sqlite"
        if(Test-Path $stickyPath){
            Write-Log "Sticky Notes database found (may contain sensitive info)" -Level Medium -Category 'Recent'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Recent'}
}

function Test-CachedCredentials{
    Write-SectionHeader -Title "CACHED CREDENTIALS" -Description "Credential Manager and LSA secrets"
    try{
        # Credential Manager
        $savedCreds=cmdkey /list 2>$null
        if($savedCreds -and $savedCreds.Length -gt 0){
            $credLines=$savedCreds|Where-Object{$_ -match 'Target:|User:'}
            if($credLines.Count -gt 0){
                Write-Log "Credentials in Credential Manager: $($credLines.Count / 2)" -Level High -Category 'Credentials' -ExploitDifficulty 2 -MitreTechniques @('T1555.003')
                if($Mode -eq 'Deep'){
                    foreach($line in $credLines|Select-Object -First 10){
                        Write-Log "  $line" -Level Info -Category 'Credentials'
                    }
                }
            }
        }else{
            Write-Log "No saved credentials in Credential Manager" -Level Success -Category 'Credentials'
        }
        
        # VaultCmd
        try{
            $vaultList=vaultcmd /list 2>$null
            if($vaultList){
                Write-Log "Windows Vault accessible" -Level Medium -Category 'Credentials'
            }
        }catch{}
        
        # Check for Mimikatz-friendly conditions
        $lsass=Get-Process lsass -ErrorAction SilentlyContinue
        if($lsass){
            Write-Log "LSASS process accessible (PID: $($lsass.Id))" -Level Info -Category 'Credentials'
            Write-Log "Credential extraction: Mimikatz, ProcDump, Dumpert" -Level Info -Category 'Credentials' -MitreTechniques @('T1003.001')
        }
        
        # LSA Protection check
        $lsaProtection=Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name RunAsPPL -ErrorAction SilentlyContinue
        if($lsaProtection -and $lsaProtection.RunAsPPL -eq 1){
            Write-Log "LSA Protection ENABLED (PPL) - credential dumping harder" -Level Success -Category 'Credentials'
        }else{
            Write-Log "LSA Protection DISABLED - credential dumping easier!" -Level Critical -Category 'Credentials' -ExploitDifficulty 2 -MitreTechniques @('T1003.001')
        }
        
        # Check for WDigest
        $wdigest=Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest" -Name UseLogonCredential -ErrorAction SilentlyContinue
        if($wdigest -and $wdigest.UseLogonCredential -eq 1){
            Write-Log "WDigest ENABLED - cleartext passwords in LSASS!" -Level Critical -Category 'Credentials' -ExploitDifficulty 1 -MitreTechniques @('T1003.001')
        }else{
            Write-Log "WDigest disabled" -Level Success -Category 'Credentials'
        }
        
        # DPAPI master keys
        $dpapi Masterkeys="$env:APPDATA\Microsoft\Protect"
        if(Test-Path $dpapiMasterkeys){
            $keys=Get-ChildItem $dpapiMasterkeys -Recurse -File -ErrorAction SilentlyContinue
            if($keys.Count -gt 0){
                Write-Log "DPAPI master keys found: $($keys.Count)" -Level High -Category 'Credentials' -MitreTechniques @('T1555.004')
            }
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Credentials'}
}

# ============================================================================
# CERTIFICATE SERVICES (ADCS) VULNERABILITIES
# ============================================================================

function Test-ADCSVulnerabilities{
    Write-SectionHeader -Title "CERTIFICATE SERVICES (ADCS)" -Description "PKI and certificate vulnerabilities"
    try{
        $cs=Get-CimInstance Win32_ComputerSystem -ErrorAction Stop
        if(-not $cs.PartOfDomain){
            Write-Log "Not domain-joined - skipping ADCS checks" -Level Info -Category 'ADCS'
            return
        }
        
        # Check if certutil is available
        $certutil=Get-Command certutil -ErrorAction SilentlyContinue
        if(-not $certutil){
            Write-Log "certutil not available" -Level Info -Category 'ADCS'
            return
        }
        
        # List certificate authorities
        try{
            $cas=certutil -config - -ping 2>$null
            if($cas){
                Write-Log "Certificate Authorities found in domain" -Level Info -Category 'ADCS'
            }
        }catch{}
        
        # Check for vulnerable certificate templates (ESC1-ESC13)
        Write-Log "ADCS vulnerability checks (ESC1-ESC13):" -Level Info -Category 'ADCS'
        Write-Log "Use Certify.exe for comprehensive ADCS enumeration:" -Level Info -Category 'ADCS'
        Write-Log "  certify.exe find /vulnerable" -Level Info -Category 'ADCS'
        
        # Common ADCS vulnerabilities
        $adcsVulns=@{
            'ESC1'='Misconfigured certificate templates (enrollee supplies SAN)'
            'ESC2'='Misconfigured certificate templates (any purpose EKU)'
            'ESC3'='Certificate request agents'
            'ESC4'='Vulnerable certificate template access control'
            'ESC5'='Vulnerable PKI object access control'
            'ESC6'='EDITF_ATTRIBUTESUBJECTALTNAME2'
            'ESC7'='Vulnerable CA access control'
            'ESC8'='NTLM relay to AD CS HTTP endpoints'
            'ESC9'='No security extension (CT_FLAG_NO_SECURITY_EXTENSION)'
            'ESC10'='Weak certificate mappings'
            'ESC11'='Relay to ICPR'
            'ESC13'='Certificate OID group link'
        }
        
        foreach($esc in $adcsVulns.Keys){
            Write-Log "$esc - $($adcsVulns[$esc])" -Level Medium -Category 'ADCS' -MitreTechniques @('T1649')
        }
        
        # Check local certificates
        $myCerts=Get-ChildItem Cert:\CurrentUser\My -ErrorAction SilentlyContinue
        if($myCerts){
            Write-Log "User certificates: $($myCerts.Count)" -Level Info -Category 'ADCS'
            foreach($cert in $myCerts|Select-Object -First 5){
                if($cert.HasPrivateKey){
                    Write-Log "Certificate with private key: $($cert.Subject)" -Level Medium -Category 'ADCS'
                }
            }
        }
        
        # Machine certificates
        $machineCerts=Get-ChildItem Cert:\LocalMachine\My -ErrorAction SilentlyContinue
        if($machineCerts){
            Write-Log "Machine certificates: $($machineCerts.Count)" -Level Info -Category 'ADCS'
        }
        
    }catch{Write-Log "Error in ADCS checks: $_" -Level Error -Category 'ADCS'}
}

# ============================================================================
# NETWORK-BASED ATTACKS
# ============================================================================

function Test-NetworkVulnerabilities{
    if($SkipNetworkChecks){return}
    Write-SectionHeader -Title "NETWORK ATTACK SURFACE" -Description "Network-based privilege escalation"
    try{
        # LLMNR/NBT-NS status
        $llmnr=Get-ItemProperty "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient" -Name EnableMulticast -ErrorAction SilentlyContinue
        if(-not $llmnr -or $llmnr.EnableMulticast -ne 0){
            Write-Log "LLMNR ENABLED - poisoning attacks possible!" -Level High -Category 'Network' -ExploitDifficulty 2 -MitreTechniques @('T1557.001')
            Write-Log "Tools: Responder, Inveigh" -Level Info -Category 'Network'
        }else{
            Write-Log "LLMNR disabled" -Level Success -Category 'Network'
        }
        
        # NBT-NS status
        $adapters=Get-WmiObject Win32_NetworkAdapterConfiguration|Where-Object{$_.IPEnabled}
        foreach($adapter in $adapters){
            if($adapter.TcpipNetbiosOptions -ne 2){
                Write-Log "NBT-NS enabled on: $($adapter.Description)" -Level High -Category 'Network' -MitreTechniques @('T1557.001')
            }
        }
        
        # SMB Signing
        $smbClient=Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters" -Name RequireSecuritySignature -ErrorAction SilentlyContinue
        if(-not $smbClient -or $smbClient.RequireSecuritySignature -eq 0){
            Write-Log "SMB signing NOT REQUIRED - relay attacks possible!" -Level Critical -Category 'Network' -ExploitDifficulty 2 -MitreTechniques @('T1557.001')
        }else{
            Write-Log "SMB client signing required" -Level Success -Category 'Network'
        }
        
        $smbServer=Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" -Name RequireSecuritySignature -ErrorAction SilentlyContinue
        if(-not $smbServer -or $smbServer.RequireSecuritySignature -eq 0){
            Write-Log "SMB server signing NOT required!" -Level High -Category 'Network'
        }
        
        # WPAD
        $wpad=Get-ItemProperty "HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Wpad" -ErrorAction SilentlyContinue
        if($wpad){
            Write-Log "WPAD configured - MITM attacks possible" -Level Medium -Category 'Network' -MitreTechniques @('T1557.001')
        }
        
        # IPv6
        $ipv6=Get-NetAdapterBinding -ComponentID ms_tcpip6 -ErrorAction SilentlyContinue|Where-Object{$_.Enabled}
        if($ipv6){
            Write-Log "IPv6 enabled - DHCPv6/DNS takeover possible!" -Level Medium -Category 'Network' -ExploitDifficulty 3 -MitreTechniques @('T1557.001')
            Write-Log "Tools: mitm6, SLAAC attack" -Level Info -Category 'Network'
        }
        
        # Open shares
        $shares=net share 2>$null|Select-String -Pattern '\ -NotMatch
        if($shares){
            Write-Log "Network shares:" -Level Info -Category 'Network'
            foreach($share in $shares|Select-Object -Skip 3 -First 10){
                Write-Log "  $share" -Level Info -Category 'Network'
            }
        }
        
        # Null session
        try{
            $nullSession=net use \\127.0.0.1\IPC$ "" /user:"" 2>$null
            if($LASTEXITCODE -eq 0){
                Write-Log "Null session ENABLED!" -Level High -Category 'Network' -ExploitDifficulty 2
                net use \\127.0.0.1\IPC$ /delete 2>$null|Out-Null
            }
        }catch{}
        
        # Listening ports
        $listeners=Get-NetTCPConnection -State Listen -ErrorAction SilentlyContinue|Select-Object LocalAddress,LocalPort,OwningProcess -Unique
        $suspiciousPorts=@(21,23,69,135,139,445,1433,3306,3389,5985,5986,8080,8443)
        foreach($listener in $listeners){
            if($listener.LocalPort -in $suspiciousPorts){
                $proc=Get-Process -Id $listener.OwningProcess -ErrorAction SilentlyContinue
                Write-Log "Listening on port $($listener.LocalPort): $($proc.Name)" -Level Medium -Category 'Network'
            }
        }
        
    }catch{Write-Log "Error in network checks: $_" -Level Error -Category 'Network'}
}

# ============================================================================
# PERSISTENCE MECHANISMS
# ============================================================================

function Test-PersistenceMechanisms{
    Write-SectionHeader -Title "PERSISTENCE ANALYSIS" -Description "Registry, startup, and persistence vectors"
    try{
        $vulnCount=0
        
        # Autorun registry keys
        $autorunKeys=@(
            "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
            "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce"
            "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
            "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce"
            "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run"
            "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx"
            "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\RunServices"
            "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\RunServicesOnce"
        )
        
        foreach($key in $autorunKeys){
            if(Test-Path $key){
                $regAcl=Get-ACLPermissions -Path $key
                if($regAcl -and $regAcl.HasWrite){
                    $vulnCount++
                    Write-Log "Writable autorun key: $key" -Level Critical -Category 'Persistence' -ExploitDifficulty 1 -MitreTechniques @('T1547.001')
                }
                
                # Check existing values
                if($Mode -eq 'Deep' -or $Mode -eq 'Paranoid'){
                    try{
                        $values=Get-ItemProperty $key -ErrorAction Stop
                        $values.PSObject.Properties|Where-Object{$_.Name -notmatch 'PS'}|ForEach-Object{
                            Write-Log "Autorun entry: $($_.Name) = $($_.Value)" -Level Info -Category 'Persistence'
                        }
                    }catch{}
                }
            }
        }
        
        # Startup folders
        $startupFolders=@(
            "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup"
            "$env:ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
            "$env:ALLUSERSPROFILE\Microsoft\Windows\Start Menu\Programs\Startup"
        )
        
        foreach($folder in $startupFolders){
            if(Test-Path $folder){
                $folderAcl=Get-ACLPermissions -Path $folder -FileSystem
                if($folderAcl -and $folderAcl.HasWrite){
                    $vulnCount++
                    Write-Log "Writable startup folder: $folder" -Level Critical -Category 'Persistence' -ExploitDifficulty 1 -MitreTechniques @('T1547.001')
                }
                
                # List existing startup items
                $items=Get-ChildItem $folder -File -ErrorAction SilentlyContinue
                if($items.Count -gt 0){
                    Write-Log "Startup items in $folder : $($items.Count)" -Level Info -Category 'Persistence'
                }
            }
        }
        
        # Image File Execution Options (IFEO)
        $ifeo="HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options"
        if(Test-Path $ifeo){
            $ifeoAcl=Get-ACLPermissions -Path $ifeo
            if($ifeoAcl -and $ifeoAcl.HasWrite){
                $vulnCount++
                Write-Log "Writable IFEO registry!" -Level Critical -Category 'Persistence' -ExploitDifficulty 1 -MitreTechniques @('T1546.012')
            }
        }
        
        # Screensaver
        $screensaver=Get-ItemProperty "HKCU:\Control Panel\Desktop" -Name SCRNSAVE.EXE -ErrorAction SilentlyContinue
        if($screensaver.'SCRNSAVE.EXE'){
            $scrPath=$screensaver.'SCRNSAVE.EXE'
            if(Test-Path $scrPath){
                $scrAcl=Get-ACLPermissions -Path $scrPath -FileSystem
                if($scrAcl -and $scrAcl.HasWrite){
                    $vulnCount++
                    Write-Log "Writable screensaver: $scrPath" -Level High -Category 'Persistence' -MitreTechniques @('T1546.002')
                }
            }
        }
        
        # Windows Terminal settings
        $terminalSettings="$env:LOCALAPPDATA\Packages\Microsoft.WindowsTerminal_8wekyb3d8bbwe\LocalState\settings.json"
        if(Test-Path $terminalSettings){
            $termAcl=Get-ACLPermissions -Path $terminalSettings -FileSystem
            if($termAcl -and $termAcl.HasWrite){
                $vulnCount++
                Write-Log "Writable Windows Terminal config" -Level Medium -Category 'Persistence'
            }
        }
        
        # Logon scripts
        $logonScripts="HKCU:\Environment"
        if(Test-Path $logonScripts){
            $userInit=Get-ItemProperty $logonScripts -Name UserInitMprLogonScript -ErrorAction SilentlyContinue
            if($userInit){
                Write-Log "User logon script configured: $($userInit.UserInitMprLogonScript)" -Level Medium -Category 'Persistence' -MitreTechniques @('T1037.001')
            }
        }
        
        if($vulnCount -eq 0){
            Write-Log "No writable persistence mechanisms found" -Level Success -Category 'Persistence'
        }else{
            Write-Log "Found $vulnCount writable persistence locations!" -Level Critical -Category 'Persistence'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Persistence'}
}

function Test-WMIPersistence{
    Write-SectionHeader -Title "WMI PERSISTENCE" -Description "WMI event subscriptions"
    try{
        $filters=Get-WmiObject -Namespace root\subscription -Class __EventFilter -ErrorAction SilentlyContinue
        $consumers=Get-WmiObject -Namespace root\subscription -Class __EventConsumer -ErrorAction SilentlyContinue
        $bindings=Get-WmiObject -Namespace root\subscription -Class __FilterToConsumerBinding -ErrorAction SilentlyContinue
        
        if($filters.Count -gt 0){
            Write-Log "WMI Event Filters: $($filters.Count)" -Level Medium -Category 'WMI' -MitreTechniques @('T1546.003')
            if($Mode -eq 'Deep'){
                foreach($filter in $filters|Select-Object -First 5){
                    Write-Log "  Filter: $($filter.Name)" -Level Info -Category 'WMI'
                }
            }
        }
        
        if($consumers.Count -gt 0){
            Write-Log "WMI Event Consumers: $($consumers.Count)" -Level Medium -Category 'WMI'
            if($Mode -eq 'Deep'){
                foreach($consumer in $consumers|Select-Object -First 5){
                    Write-Log "  Consumer: $($consumer.__CLASS)" -Level Info -Category 'WMI'
                }
            }
        }
        
        if($bindings.Count -gt 0){
            Write-Log "WMI Bindings: $($bindings.Count) - ACTIVE PERSISTENCE!" -Level High -Category 'WMI' -ExploitDifficulty 2 -MitreTechniques @('T1546.003')
        }
        
        if($filters.Count -eq 0 -and $consumers.Count -eq 0 -and $bindings.Count -eq 0){
            Write-Log "No WMI persistence detected" -Level Success -Category 'WMI'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'WMI'}
}

function Test-COMHijacking{
    Write-SectionHeader -Title "COM HIJACKING" -Description "COM object hijacking opportunities"
    try{
        # User CLSID entries
        $userCLSID="HKCU:\Software\Classes\CLSID"
        if(Test-Path $userCLSID){
            $clsids=Get-ChildItem $userCLSID -ErrorAction SilentlyContinue
            if($clsids.Count -gt 0){
                Write-Log "User CLSID entries: $($clsids.Count)" -Level Medium -Category 'COM' -MitreTechniques @('T1546.015')
                if($Mode -eq 'Deep'){
                    foreach($clsid in $clsids|Select-Object -First 5){
                        Write-Log "  $($clsid.PSChildName)" -Level Info -Category 'COM'
                    }
                }
            }
        }
        
        # Check writable system CLSID
        $systemCLSID="HKLM:\Software\Classes\CLSID"
        if(Test-Path $systemCLSID){
            $sysAcl=Get-ACLPermissions -Path $systemCLSID
            if($sysAcl -and $sysAcl.HasWrite){
                Write-Log "SYSTEM CLSID registry WRITABLE!" -Level Critical -Category 'COM' -ExploitDifficulty 2 -MitreTechniques @('T1546.015')
            }
        }
        
        # TreatAs keys
        $treatAs=Get-ChildItem "HKCU:\Software\Classes\CLSID" -Recurse -ErrorAction SilentlyContinue|Where-Object{$_.PSChildName -eq 'TreatAs'}
        if($treatAs.Count -gt 0){
            Write-Log "TreatAs COM redirections: $($treatAs.Count)" -Level Medium -Category 'COM'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'COM'}
}

# ============================================================================
# DLL HIJACKING & PATH MANIPULATION
# ============================================================================

function Find-DLLHijacking{
    Write-SectionHeader -Title "DLL HIJACKING" -Description "PATH and DLL search order exploitation"
    try{
        # Current directory in PATH
        if($env:PATH -match '(^\.;|;\.;|;\.$)'){
            Write-Log "Current directory (.) in PATH - CRITICAL!" -Level Critical -Category 'DLLHijacking' -ExploitDifficulty 1 -MitreTechniques @('T1574.001')
        }
        
        # Writable PATH directories
        $pathDirs=$env:PATH -split ';'|Where-Object{$_}
        $vulnCount=0
        
        foreach($dir in $pathDirs){
            if(Test-Path $dir -ErrorAction SilentlyContinue){
                $acl=Get-ACLPermissions -Path $dir -FileSystem
                if($acl -and $acl.HasWrite){
                    $vulnCount++
                    Write-Log "Writable PATH directory: $dir" -Level High -Category 'DLLHijacking' -ExploitDifficulty 2 -MitreTechniques @('T1574.001')
                }
            }
        }
        
        # System32 and SysWOW64 DLL planting
        $systemDirs=@("C:\Windows\System32","C:\Windows\SysWOW64")
        foreach($sysDir in $systemDirs){
            if(Test-Path $sysDir){
                $sysAcl=Get-ACLPermissions -Path $sysDir -FileSystem
                if($sysAcl -and $sysAcl.HasWrite){
                    $vulnCount++
                    Write-Log "Writable system directory: $sysDir" -Level Critical -Category 'DLLHijacking' -ExploitDifficulty 1
                }
            }
        }
        
        # Program Files writability
        $programDirs=@("C:\Program Files","C:\Program Files (x86)")
        foreach($progDir in $programDirs){
            if(Test-Path $progDir){
                $progAcl=Get-ACLPermissions -Path $progDir -FileSystem
                if($progAcl -and $progAcl.HasWrite){
                    $vulnCount++
                    Write-Log "Writable: $progDir" -Level Critical -Category 'DLLHijacking' -ExploitDifficulty 1
                }
            }
        }
        
        # CWDIllegalInDllSearch
        $dllSearch=Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager" -Name CWDIllegalInDllSearch -ErrorAction SilentlyContinue
        if(-not $dllSearch -or $dllSearch.CWDIllegalInDllSearch -eq 0){
            Write-Log "CWDIllegalInDllSearch not set - DLL planting easier" -Level Medium -Category 'DLLHijacking' -MitreTechniques @('T1574.001')
        }
        
        # SafeDllSearchMode
        $safeDll=Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager" -Name SafeDllSearchMode -ErrorAction SilentlyContinue
        if($safeDll -and $safeDll.SafeDllSearchMode -eq 0){
            Write-Log "SafeDllSearchMode DISABLED!" -Level High -Category 'DLLHijacking'
        }
        
        if($vulnCount -eq 0){
            Write-Log "No obvious DLL hijacking vectors" -Level Success -Category 'DLLHijacking'
        }else{
            Write-Log "Found $vulnCount DLL hijacking opportunities" -Level Critical -Category 'DLLHijacking'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'DLLHijacking'}
}

# ============================================================================
# UAC & ELEVATION
# ============================================================================

function Test-UACBypass{
    Write-SectionHeader -Title "UAC BYPASS VECTORS" -Description "User Account Control analysis"
    try{
        $uac=Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -ErrorAction SilentlyContinue
        
        # UAC status
        if($uac.EnableLUA -eq 0){
            Write-Log "UAC COMPLETELY DISABLED!" -Level Critical -Category 'UAC' -ExploitDifficulty 1 -MitreTechniques @('T1548.002')
        }elseif($uac.ConsentPromptBehaviorAdmin -eq 0){
            Write-Log "UAC set to never notify - no elevation prompts!" -Level Critical -Category 'UAC' -ExploitDifficulty 1 -MitreTechniques @('T1548.002')
        }elseif($uac.ConsentPromptBehaviorAdmin -eq 5){
            Write-Log "UAC: Prompt for consent (default)" -Level Info -Category 'UAC'
        }
        
        # FilterAdministratorToken
        if($uac.FilterAdministratorToken -eq 0){
            Write-Log "FilterAdministratorToken disabled - built-in Admin not filtered" -Level Medium -Category 'UAC'
        }
        
        # UAC bypass binaries
        $bypassBins=@{
            'fodhelper.exe'='Registry hijacking'
            'eventvwr.msc'='Registry hijacking'
            'ComputerDefaults.exe'='Registry hijacking'
            'sdclt.exe'='Registry hijacking'
            'SilentCleanup'='Scheduled task'
            'DiskCleanup'='Environment variable'
            'SystemPropertiesAdvanced.exe'='Mock directory'
            'WSReset.exe'='Registry hijacking'
            'slui.exe'='Registry hijacking'
            'changepk.exe'='Registry hijacking'
        }
        
        Write-Log "UAC bypass vectors available:" -Level High -Category 'UAC'
        foreach($binary in $bypassBins.Keys){
            Write-Log "  $binary - $($bypassBins[$binary])" -Level High -Category 'UAC' -ExploitDifficulty 2 -MitreTechniques @('T1548.002')
        }
        
        # Auto-elevation
        $autoElevate=Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name EnableInstallerDetection -ErrorAction SilentlyContinue
        if($autoElevate -and $autoElevate.EnableInstallerDetection -eq 1){
            Write-Log "Installer detection enabled (auto-elevation)" -Level Medium -Category 'UAC'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'UAC'}
}

# ============================================================================
# DRIVERS & KERNEL MODE
# ============================================================================

function Get-VulnerableDrivers{
    Write-SectionHeader -Title "VULNERABLE DRIVERS" -Description "BYOVD and unsigned drivers"
    try{
        $drivers=driverquery /v /fo csv 2>$null|ConvertFrom-Csv
        if(-not $drivers){
            Write-Log "Could not enumerate drivers" -Level Warning -Category 'Drivers'
            return
        }
        
        # Known vulnerable drivers (BYOVD - Bring Your Own Vulnerable Driver)
        $vulnDrivers=@{
            'rtcore64.sys'='MSI Afterburner - arbitrary R/W'
            'gdrv.sys'='Gigabyte - arbitrary R/W'
            'capcom.sys'='Capcom - arbitrary code execution'
            'dbutil_2_3.sys'='Dell BIOS - arbitrary R/W'
            'aswArPot.sys'='Avast - arbitrary R/W'
            'iqvw64e.sys'='Intel - arbitrary R/W'
            'atillk64.sys'='ASRock - arbitrary R/W'
            'RTCore64.sys'='MSI Afterburner'
            'GLCKIO2.sys'='ASRock - arbitrary R/W'
            'EneIo64.sys'='MSI Dragon Center'
            'WinRing0x64.sys'='WinRing0 - arbitrary R/W'
        }
        
        $driverList=$drivers|Select-Object -ExpandProperty 'Module Name'
        $foundVuln=0
        
        foreach($vuln in $vulnDrivers.Keys){
            if($driverList -contains $vuln){
                $foundVuln++
                Write-Log "VULNERABLE DRIVER: $vuln - $($vulnDrivers[$vuln])" -Level Critical -Category 'Drivers' -ExploitDifficulty 3 -MitreTechniques @('T1068')
            }
        }
        
        # Unsigned drivers
        $unsigned=$drivers|Where-Object{$_.Signed -eq 'False'}
        if($unsigned.Count -gt 0){
            Write-Log "Unsigned drivers: $($unsigned.Count)" -Level High -Category 'Drivers' -ExploitDifficulty 4
            if($Mode -eq 'Deep'){
                foreach($driver in $unsigned|Select-Object -First 5){
                    Write-Log "  $($driver.'Module Name')" -Level Info -Category 'Drivers'
                }
            }
        }
        
        # Third-party drivers
        $thirdParty=$drivers|Where-Object{$_.Provider -notmatch 'Microsoft'}
        Write-Log "Third-party drivers: $($thirdParty.Count)" -Level Info -Category 'Drivers'
        
        if($foundVuln -eq 0 -and $unsigned.Count -eq 0){
            Write-Log "No obviously vulnerable drivers detected" -Level Success -Category 'Drivers'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Drivers'}
}

# ============================================================================
# SECURITY PRODUCTS & EDR
# ============================================================================

function Get-SecurityProducts{
    Write-SectionHeader -Title "SECURITY PRODUCTS" -Description "AV/EDR/XDR detection"
    try{
        # Antivirus products
        $avProducts=Get-CimInstance -Namespace root\SecurityCenter2 -ClassName AntiVirusProduct -ErrorAction SilentlyContinue
        if($avProducts){
            foreach($av in $avProducts){
                Write-Log "Antivirus: $($av.displayName) | State: $($av.productState)" -Level Info -Category 'Security'
            }
        }
        
        # Known security processes
        $secProcs=@{
            'MsMpEng'='Windows Defender'
            'MsSense'='Microsoft Defender for Endpoint'
            'SenseIR'='Microsoft Defender for Endpoint'
            'cb'='Carbon Black'
            'CbDefense'='Carbon Black Defense'
            'CylanceSvc'='Cylance'
            'CSFalconService'='CrowdStrike Falcon'
            'CSFalconContainer'='CrowdStrike Falcon Container'
            'xagt'='FireEye'
            'QualysAgent'='Qualys'
            'SentinelAgent'='SentinelOne'
            'SentinelOne'='SentinelOne'
            'SentinelStaticEngine'='SentinelOne'
            'LogProcessorService'='SentinelOne'
            'taniumclient'='Tanium'
            'TaniumEndpointIndex'='Tanium'
            'EPSecurityService'='Palo Alto Cortex XDR'
            'CETASvc'='Palo Alto Cortex XDR'
            'TmListen'='Trend Micro'
            'PccNTMon'='Trend Micro'
            'WRSVC'='Webroot'
            'Avast'='Avast'
            'AVG'='AVG'
            'ekrn'='ESET'
            'eguiProxy'='ESET'
            'bdagent'='Bitdefender'
            'epag'='Bitdefender'
            'TmCCSF'='Trend Micro'
            'sophossps'='Sophos'
            'SAVService'='Sophos'
            'SEDService'='Sophos EDR'
            'Elastic'='Elastic Agent'
            'winlogbeat'='Elastic Winlogbeat'
            'fortitray'='FortiClient'
        }
        
        $running=Get-Process|Select-Object -ExpandProperty Name
        $detected=@()
        
        foreach($proc in $secProcs.Keys){
            if($running -contains $proc){
                $detected+=$secProcs[$proc]
                Write-Log "EDR/AV detected: $($secProcs[$proc]) ($proc)" -Level Info -Category 'Security'
            }
        }
        
        # Windows Defender status
        if($running -contains 'MsMpEng'){
            try{
                $defenderStatus=Get-MpComputerStatus -ErrorAction SilentlyContinue
                if($defenderStatus){
                    Write-Log "Defender RealTime: $($defenderStatus.RealTimeProtectionEnabled)" -Level Info -Category 'Security'
                    Write-Log "Defender TamperProtection: $($defenderStatus.IsTamperProtected)" -Level Info -Category 'Security'
                    if(-not $defenderStatus.RealTimeProtectionEnabled){
                        Write-Log "Defender real-time protection DISABLED!" -Level High -Category 'Security'
                    }
                }
            }catch{}
        }
        
        # Check for AMSI
        $amsi=Get-Command Get-AmsiLibrary -ErrorAction SilentlyContinue
        if($amsi){
            Write-Log "AMSI (Anti-Malware Scan Interface) available" -Level Info -Category 'Security'
        }
        
        # Sysmon
        $sysmon=Get-Service Sysmon* -ErrorAction SilentlyContinue
        if($sysmon){
            Write-Log "Sysmon detected: $($sysmon.Name)" -Level Info -Category 'Security'
        }
        
        if($detected.Count -eq 0 -and -not $avProducts -and -not $sysmon){
            Write-Log "No obvious security products detected" -Level Info -Category 'Security'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Security'}
}

# ============================================================================
# ACTIVE DIRECTORY INTEGRATION
# ============================================================================

function Get-ActiveDirectoryInfo{
    Write-SectionHeader -Title "ACTIVE DIRECTORY" -Description "Domain configuration and AD attacks"
    try{
        $cs=Get-CimInstance Win32_ComputerSystem -ErrorAction Stop
        
        if(-not $cs.PartOfDomain){
            Write-Log "Not domain-joined" -Level Info -Category 'AD'
            return
        }
        
        Write-Log "Domain-joined: $($cs.Domain)" -Level High -Category 'AD'
        
        # LAPS
        $lapsKey="HKLM:\SOFTWARE\Policies\Microsoft Services\AdmPwd"
        if(Test-Path $lapsKey){
            Write-Log "LAPS configured" -Level Success -Category 'AD'
            $lapsSettings=Get-ItemProperty $lapsKey -ErrorAction SilentlyContinue
            if($lapsSettings.AdmPwdEnabled -eq 1){
                Write-Log "LAPS is active" -Level Success -Category 'AD'
            }
        }else{
            Write-Log "LAPS NOT configured - local admin passwords may be shared!" -Level High -Category 'AD' -ExploitDifficulty 3 -MitreTechniques @('T1078.003')
        }
        
        # Domain trust
        Write-Log "Domain enumeration tools: BloodHound, PowerView, ADRecon" -Level Info -Category 'AD'
        
        # Check for cached domain credentials
        $cachedLogons=Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" -Name CachedLogonsCount -ErrorAction SilentlyContinue
        if($cachedLogons){
            Write-Log "Cached domain logons allowed: $($cachedLogons.CachedLogonsCount)" -Level Medium -Category 'AD' -MitreTechniques @('T1003.005')
        }
        
        # Kerberos settings
        $kerberos=klist tickets 2>$null
        if($kerberos){
            Write-Log "Kerberos tickets present - check for delegation" -Level Info -Category 'AD'
        }
        
        # Domain controller detection
        try{
            $dc=[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain().DomainControllers
            if($dc){
                Write-Log "Domain Controller: $($dc[0].Name)" -Level Info -Category 'AD'
            }
        }catch{}
        
        # GPO information
        $gpos=Get-ChildItem "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\History" -ErrorAction SilentlyContinue
        if($gpos){
            Write-Log "Applied GPOs: $($gpos.Count)" -Level Info -Category 'AD'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'AD'}
}

# ============================================================================
# MISCELLANEOUS VECTORS
# ============================================================================

function Test-PrintSpooler{
    Write-SectionHeader -Title "PRINT SPOOLER" -Description "PrintNightmare and related exploits"
    try{
        $spooler=Get-Service Spooler -ErrorAction SilentlyContinue
        if($spooler -and $spooler.Status -eq 'Running'){
            Write-Log "Print Spooler RUNNING" -Level High -Category 'PrintSpooler' -ExploitDifficulty 2 -MitreTechniques @('T1068')
            Write-Log "Vulnerabilities: PrintNightmare (CVE-2021-1675/34527)" -Level High -Category 'PrintSpooler'
            
            # Check Point and Print
            $pointAndPrint=Get-ItemProperty "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint" -ErrorAction SilentlyContinue
            if($pointAndPrint){
                if($pointAndPrint.RestrictDriverInstallationToAdministrators -eq 0){
                    Write-Log "Point and Print: Non-admins can install drivers!" -Level Critical -Category 'PrintSpooler' -ExploitDifficulty 1
                }
            }
        }else{
            Write-Log "Print Spooler not running" -Level Success -Category 'PrintSpooler'
        }
    }catch{Write-Log "Error: $_" -Level Error -Category 'PrintSpooler'}
}

function Get-NamedPipes{
    Write-SectionHeader -Title "NAMED PIPES" -Description "IPC and pipe impersonation"
    try{
        $pipes=[System.IO.Directory]::GetFiles("\\.\\pipe\\")
        Write-Log "Named pipes: $($pipes.Count)" -Level Info -Category 'Pipes'
        
        $interestingPipes=@('lsass','sam','winreg','spoolss','srvsvc','ntsvcs','epmapper','wkssvc','browser')
        $foundInteresting=0
        
        foreach($pipe in $pipes){
            $pipeName=[System.IO.Path]::GetFileName($pipe)
            foreach($interesting in $interestingPipes){
                if($pipeName -like "*$interesting*"){
                    $foundInteresting++
                    Write-Log "Interesting pipe: $pipeName" -Level Medium -Category 'Pipes' -MitreTechniques @('T1055.012')
                    break
                }
            }
        }
        
        if($foundInteresting -eq 0){
            Write-Log "No particularly interesting pipes found" -Level Info -Category 'Pipes'
        }
        
        # Token impersonation via pipes
        Write-Log "Pipe impersonation tools: PipeViewer, AccessChk" -Level Info -Category 'Pipes'
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Pipes'}
}

function Test-AccessibilityFeatures{
    Write-SectionHeader -Title "ACCESSIBILITY FEATURES" -Description "Sticky Keys and similar hijacks"
    try{
        $accessibilityFeatures=@{
            'C:\Windows\System32\sethc.exe'='Sticky Keys'
            'C:\Windows\System32\utilman.exe'='Utility Manager'
            'C:\Windows\System32\osk.exe'='On-Screen Keyboard'
            'C:\Windows\System32\Magnify.exe'='Magnifier'
            'C:\Windows\System32\Narrator.exe'='Narrator'
            'C:\Windows\System32\DisplaySwitch.exe'='Display Switch'
            'C:\Windows\System32\AtBroker.exe'='Application Compatibility'
        }
        
        $vulnCount=0
        foreach($feature in $accessibilityFeatures.Keys){
            if(Test-Path $feature){
                $acl=Get-ACLPermissions -Path $feature -FileSystem
                if($acl -and $acl.HasWrite){
                    $vulnCount++
                    Write-Log "WRITABLE: $($accessibilityFeatures[$feature]) - $feature" -Level Critical -Category 'Accessibility' -ExploitDifficulty 1 -MitreTechniques @('T1546.008')
                }
            }
        }
        
        if($vulnCount -eq 0){
            Write-Log "Accessibility features not writable" -Level Success -Category 'Accessibility'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Accessibility'}
}

function Get-ShadowCopies{
    Write-SectionHeader -Title "VOLUME SHADOW COPIES" -Description "VSS and backup data"
    try{
        $shadowCopies=Get-WmiObject Win32_ShadowCopy -ErrorAction SilentlyContinue
        if($shadowCopies -and $shadowCopies.Count -gt 0){
            Write-Log "Shadow copies: $($shadowCopies.Count)" -Level High -Category 'ShadowCopy' -MitreTechniques @('T1003.002')
            Write-Log "May contain: old passwords, deleted files, credential backups" -Level High -Category 'ShadowCopy'
            Write-Log "Access: mklink /d C:\shadowcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy[N]\" -Level Info -Category 'ShadowCopy'
            
            # HiveNightmare/SeriousSAM check
            $build=[int]$script:Config.SystemInfo.Build
            if($build -ge 19041 -and $build -le 19043){
                Write-Log "System may be vulnerable to HiveNightmare (CVE-2021-36934)!" -Level Critical -Category 'ShadowCopy' -ExploitDifficulty 2
            }
        }else{
            Write-Log "No shadow copies found" -Level Info -Category 'ShadowCopy'
        }
        
        # VSS admin tools
        $vssadmin=Get-Command vssadmin -ErrorAction SilentlyContinue
        if($vssadmin){
            Write-Log "vssadmin available for shadow copy management" -Level Info -Category 'ShadowCopy'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'ShadowCopy'}
}

function Test-AppLocker{
    Write-SectionHeader -Title "APPLOCKER/WDAC" -Description "Application control policies"
    try{
        $appLockerPolicy=Get-AppLockerPolicy -Effective -ErrorAction SilentlyContinue
        if($appLockerPolicy){
            Write-Log "AppLocker IS configured" -Level Info -Category 'AppLocker'
            
            # Check for bypass paths
            $bypassPaths=@(
                'C:\Windows\Tasks'
                'C:\Windows\Temp'
                'C:\Windows\tracing'
                'C:\Windows\Registration\CRMLog'
                'C:\Windows\System32\FxsTmp'
                'C:\Windows\System32\com\dmp'
                'C:\Windows\System32\Microsoft\Crypto\RSA\MachineKeys'
                'C:\Windows\System32\spool\drivers\color'
                'C:\ProgramData'
                'C:\Windows\System32\Tasks'
            )
            
            $writableBypass=0
            foreach($path in $bypassPaths){
                if(Test-Path $path){
                    $acl=Get-ACLPermissions -Path $path -FileSystem
                    if($acl -and $acl.HasWrite){
                        $writableBypass++
                        Write-Log "Writable AppLocker bypass: $path" -Level Critical -Category 'AppLocker' -ExploitDifficulty 2 -MitreTechniques @('T1562.001')
                    }
                }
            }
            
            if($writableBypass -eq 0){
                Write-Log "No writable AppLocker bypass paths found" -Level Success -Category 'AppLocker'
            }
        }else{
            Write-Log "AppLocker NOT configured" -Level Info -Category 'AppLocker'
        }
        
        # WDAC (Windows Defender Application Control)
        $wdac=Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\Microsoft\Windows\DeviceGuard -ErrorAction SilentlyContinue
        if($wdac -and $wdac.CodeIntegrityPolicyEnforcementStatus -eq 1){
            Write-Log "WDAC (Device Guard) in enforcement mode" -Level Info -Category 'AppLocker'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'AppLocker'}
}

function Test-EnvironmentVariables{
    Write-SectionHeader -Title "ENVIRONMENT VARIABLES" -Description "Sensitive data in environment"
    try{
        $envVars=Get-ChildItem Env:
        $suspiciousCount=0
        
        foreach($var in $envVars){
            if($var.Name -match 'PASSWORD|PWD|SECRET|KEY|TOKEN|API|CREDENTIAL|AUTH'){
                $suspiciousCount++
                Write-Log "Suspicious env var: $($var.Name)" -Level High -Category 'Environment' -ExploitDifficulty 1 -Sensitive
            }
        }
        
        # .NET profiler DLL injection
        if($env:COR_PROFILER){
            Write-Log "COR_PROFILER set - .NET DLL injection vector!" -Level Critical -Category 'Environment' -ExploitDifficulty 2 -MitreTechniques @('T1574.012')
            Write-Log "COR_PROFILER: $($env:COR_PROFILER)" -Level Info -Category 'Environment'
        }
        
        if($env:COR_PROFILER_PATH){
            Write-Log "COR_PROFILER_PATH: $($env:COR_PROFILER_PATH)" -Level Critical -Category 'Environment'
        }
        
        # Check writable TEMP/TMP
        $tempPaths=@($env:TEMP,$env:TMP,"$env:LOCALAPPDATA\Temp","C:\Windows\Temp")
        foreach($temp in $tempPaths){
            if(Test-Path $temp){
                $tempAcl=Get-ACLPermissions -Path $temp -FileSystem
                if($tempAcl -and $tempAcl.HasWrite){
                    Write-Log "Writable temp: $temp" -Level Info -Category 'Environment'
                }
            }
        }
        
        if($suspiciousCount -eq 0){
            Write-Log "No suspicious environment variables" -Level Success -Category 'Environment'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Environment'}
}

function Get-NetworkConfiguration{
    Write-SectionHeader -Title "NETWORK CONFIGURATION" -Description "Network interfaces and firewall"
    try{
        # Network adapters
        $adapters=Get-NetIPAddress -ErrorAction SilentlyContinue|Where-Object{$_.AddressFamily -eq 'IPv4' -and $_.IPAddress -ne '127.0.0.1'}
        foreach($adapter in $adapters){
            Write-Log "$($adapter.InterfaceAlias): $($adapter.IPAddress)" -Level Info -Category 'Network'
        }
        
        # Firewall profiles
        $profiles=Get-NetFirewallProfile -ErrorAction SilentlyContinue
        foreach($profile in $profiles){
            if(-not $profile.Enabled){
                Write-Log "Firewall DISABLED: $($profile.Name)" -Level Critical -Category 'Network' -MitreTechniques @('T1562.004')
            }else{
                Write-Log "Firewall $($profile.Name): Enabled" -Level Success -Category 'Network'
            }
        }
        
        # Remote Desktop
        $rdp=Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -ErrorAction SilentlyContinue
        if($rdp -and $rdp.fDenyTSConnections -eq 0){
            Write-Log "Remote Desktop ENABLED" -Level Medium -Category 'Network' -MitreTechniques @('T1021.001')
        }
        
        # WinRM
        $winrm=Get-Service WinRM -ErrorAction SilentlyContinue
        if($winrm -and $winrm.Status -eq 'Running'){
            Write-Log "WinRM service running" -Level Medium -Category 'Network' -MitreTechniques @('T1021.006')
        }
        
        # Network shares
        $shares=Get-SmbShare -ErrorAction SilentlyContinue|Where-Object{$_.Name -notmatch '\}
        if($shares){
            Write-Log "SMB shares: $($shares.Count)" -Level Info -Category 'Network'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Network'}
}

function Get-ProcessInfo{
    Write-SectionHeader -Title "PROCESS ENUMERATION" -Description "Running processes and privileges"
    try{
        if(-not $script:Config.Cache.Processes){
            $script:Config.Cache.Processes=Get-WmiObject Win32_Process -ErrorAction SilentlyContinue
        }
        $processes=$script:Config.Cache.Processes
        
        # SYSTEM processes
        $systemProcs=$processes|Where-Object{
            $owner=$_.GetOwner()
            $owner.User -eq 'SYSTEM'
        }|Select-Object -First 25
        
        Write-Log "SYSTEM processes: $($systemProcs.Count)" -Level Info -Category 'Processes'
        
        # Unquoted process paths
        foreach($proc in $systemProcs|Select-Object -First 50){
            $path=$proc.ExecutablePath
            if($path -and $path -notmatch '^"' -and $path -match '\s' -and $path -match '\.exe'){
                Write-Log "Unquoted SYSTEM process: $($proc.Name) - $path" -Level Medium -Category 'Processes'
            }
        }
        
        # SeDebugPrivilege check
        $privOutput=whoami /priv /fo csv|ConvertFrom-Csv
        $debugPriv=$privOutput|Where-Object{$_.'Privilege Name' -eq 'SeDebugPrivilege'}
        if($debugPriv -and $debugPriv.State -match 'Enabled'){
            Write-Log "SeDebugPrivilege ENABLED - can inject into any process!" -Level Critical -Category 'Processes' -ExploitDifficulty 2 -MitreTechniques @('T1055')
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'Processes'}
}

function Test-BitLocker{
    Write-SectionHeader -Title "BITLOCKER ENCRYPTION" -Description "Disk encryption status"
    try{
        $volumes=Get-BitLockerVolume -ErrorAction SilentlyContinue
        if($volumes){
            foreach($vol in $volumes){
                if($vol.ProtectionStatus -eq 'Off'){
                    Write-Log "Volume $($vol.MountPoint) - BitLocker NOT enabled" -Level Medium -Category 'BitLocker' -MitreTechniques @('T1006')
                }else{
                    Write-Log "Volume $($vol.MountPoint) - BitLocker enabled ($($vol.EncryptionPercentage)%)" -Level Success -Category 'BitLocker'
                }
            }
        }else{
            Write-Log "BitLocker not configured or not available" -Level Info -Category 'BitLocker'
        }
        
        # TPM status
        $tpm=Get-Tpm -ErrorAction SilentlyContinue
        if($tpm){
            Write-Log "TPM Present: $($tpm.TpmPresent) | Ready: $($tpm.TpmReady)" -Level Info -Category 'BitLocker'
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'BitLocker'}
}

function Get-LOLBASBinaries{
    Write-SectionHeader -Title "LOLBAS BINARIES" -Description "Living Off The Land binaries"
    try{
        $lolbasBinaries=@{
            'C:\Windows\System32\certutil.exe'='Download/encode/decode'
            'C:\Windows\System32\bitsadmin.exe'='Download/persist'
            'C:\Windows\System32\regsvr32.exe'='Execute DLLs/COM'
            'C:\Windows\System32\mshta.exe'='Execute HTA/VBScript'
            'C:\Windows\System32\rundll32.exe'='Execute DLLs'
            'C:\Windows\System32\wmic.exe'='Execute commands/XSL'
            'C:\Windows\Microsoft.NET\Framework64\v4.0.30319\msbuild.exe'='Execute C# code'
            'C:\Windows\System32\regasm.exe'='Execute .NET'
            'C:\Windows\System32\regsvcs.exe'='Execute .NET'
            'C:\Windows\System32\installutil.exe'='Execute .NET'
            'C:\Windows\System32\cscript.exe'='Execute scripts'
            'C:\Windows\System32\wscript.exe'='Execute scripts'
            'C:\Windows\System32\forfiles.exe'='Execute commands'
            'C:\Windows\System32\pcalua.exe'='Execute binaries'
            'C:\Windows\System32\mavinject.exe'='DLL injection'
        }
        
        $availableCount=0
        foreach($binary in $lolbasBinaries.Keys){
            if(Test-Path $binary){
                $availableCount++
            }
        }
        
        Write-Log "LOLBAS binaries available: $availableCount" -Level Info -Category 'LOLBAS' -MitreTechniques @('T1218')
        
        if($Mode -eq 'Deep' -or $Mode -eq 'Paranoid'){
            foreach($binary in $lolbasBinaries.Keys){
                if(Test-Path $binary){
                    Write-Log "  $binary - $($lolbasBinaries[$binary])" -Level Info -Category 'LOLBAS'
                }
            }
        }
        
    }catch{Write-Log "Error: $_" -Level Error -Category 'LOLBAS'}
}

# ============================================================================
# MODERN WINDOWS FEATURES
# ============================================================================

function Test-ModernWindowsFeatures{
    Write-SectionHeader -Title "MODERN WINDOWS FEATURES" -Description "Windows 10/11 specific vectors"
    try{
        # Windows Subsystem for Android
        if(Test-Path "$env:LOCALAPPDATA\Packages\MicrosoftCorporationII.WindowsSubsystemForAndroid_8wekyb3d8bbwe"){
            Write-Log "WSA (Windows Subsystem for Android) installed" -Level Medium -Category 'Modern'
        }
        
        # Windows Sandbox
        $sandbox=Get-WindowsOptionalFeature -Online -FeatureName "Containers-DisposableClientVM" -ErrorAction SilentlyContinue
        if($sandbox -and $sandbox.State -eq 'Enabled'){
            Write-Log "Windows Sandbox enabled" -Level Info -Category 'Modern'
        }
        
        # Windows Terminal profiles
        $terminalSettings="$env:LOCALAPPDATA\Packages\Microsoft.WindowsTerminal_8wekyb3d8bbwe\LocalState\settings.json"
        if(Test-Path $terminalSettings){
            Write-Log "Windows Terminal installed - check profile commands" -Level Info -Category 'Modern'
        }
        
        # Microsoft Store apps with capabilities
        $appxPackages=Get-AppxPackage -ErrorAction SilentlyContinue
        if($appxPackages){
            Write-Log "AppX packages installed: $($appxPackages.Count)" -Level Info -Category 'Modern'
        }
        
        # Windows Hello
        $hello=Get-ItemProperty "HKLM:\SOFTWARE\Policies\Microsoft\PassportForWork" -ErrorAction SilentlyContinue
        if($hello){
            Write-Log "Windows Hello configured" -Level Info -Category 'Modern'
        }
        
    }catch{Write-Log "Error in modern features check: $_" -Level Error -Category 'Modern'}
}

# ============================================================================
# FINAL REPORT GENERATION
# ============================================================================

function Write-FinalReport{
    Write-SectionHeader -Title "ASSESSMENT COMPLETE" -Description "Comprehensive summary and risk analysis"
    
    $duration=(Get-Date)-$script:Config.StartTime
    Write-Host "`n" -NoNewline
    
    if(-not $NoColor){
        Write-Host "═══════════════════════════════════════════════════════════════════" -ForegroundColor Cyan
        Write-Host "  FINAL ASSESSMENT SUMMARY" -ForegroundColor Cyan
        Write-Host "═══════════════════════════════════════════════════════════════════" -ForegroundColor Cyan
    }
    
    Write-Log "Assessment Mode: $Mode" -Level Info -Category 'Summary'
    Write-Log "Duration: $($duration.ToString('mm\:ss'))" -Level Info -Category 'Summary'
    Write-Log "Total Findings: $($script:Config.Findings.Count)" -Level Info -Category 'Summary'
    
    if($script:Config.Findings.Count -gt 0){
        Write-Host "`nSEVERITY BREAKDOWN:" -ForegroundColor Cyan
        Write-Log "  Critical: $($script:Config.Statistics.Critical)" -Level Critical -Category 'Summary'
        Write-Log "  High: $($script:Config.Statistics.High)" -Level High -Category 'Summary'
        Write-Log "  Medium: $($script:Config.Statistics.Medium)" -Level Medium -Category 'Summary'
        Write-Log "  Low: $($script:Config.Statistics.Low)" -Level Low -Category 'Summary'
        Write-Log "  Info: $($script:Config.Statistics.Info)" -Level Info -Category 'Summary'
    }
    
    # Calculate risk score
    $riskScore=($script:Config.Statistics.Critical*10)+($script:Config.Statistics.High*5)+($script:Config.Statistics.Medium*2)+($script:Config.Statistics.Low*1)
    $riskLevel=if($riskScore -gt 100){"CRITICAL"}elseif($riskScore -gt 50){"HIGH"}elseif($riskScore -gt 20){"MEDIUM"}else{"LOW"}
    
    Write-Host "`nRISK ASSESSMENT:" -ForegroundColor Cyan
    Write-Log "Risk Score: $riskScore" -Level Info -Category 'Summary'
    Write-Log "Risk Level: $riskLevel" -Level $(if($riskLevel -eq "CRITICAL"){"Critical"}elseif($riskLevel -eq "HIGH"){"High"}else{"Medium"}) -Category 'Summary'
    
    # Top vulnerabilities
    if($script:Config.Statistics.Critical -gt 0){
        Write-Host "`nTOP CRITICAL FINDINGS:" -ForegroundColor Red
        $critical=$script:Config.Findings|Where-Object{$_.Level -eq 'Critical'}|Select-Object -First 10
        foreach($finding in $critical){
            Write-Host "  • $($finding.Message)" -ForegroundColor Red
        }
    }
    
    # MITRE ATT&CK summary
    $mitreUsed=$script:Config.Findings|Where-Object{$_.MitreTechniques.Count -gt 0}|Select-Object -ExpandProperty MitreTechniques|Sort-Object -Unique
    if($mitreUsed.Count -gt 0){
        Write-Host "`nMITRE ATT&CK TECHNIQUES IDENTIFIED:" -ForegroundColor Cyan
        Write-Log "Unique techniques: $($mitreUsed.Count)" -Level Info -Category 'Summary'
        if($Mode -eq 'Deep' -or $Mode -eq 'Paranoid'){
            foreach($technique in $mitreUsed|Select-Object -First 15){
                Write-Log "  $technique" -Level Info -Category 'Summary'
            }
        }
    }
    
    # Export JSON
    if($JSON){
        try{
            $jsonOutput=[PSCustomObject]@{
                Assessment=@{
                    Version=$script:Config.Version
                    StartTime=$script:Config.StartTime.ToString("yyyy-MM-dd HH:mm:ss")
                    EndTime=(Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
                    Duration=$duration.TotalSeconds
                    Mode=$Mode
                }
                SystemInfo=$script:Config.SystemInfo
                Statistics=$script:Config.Statistics
                RiskScore=$riskScore
                RiskLevel=$riskLevel
                MitreTechniques=$mitreUsed
                Findings=$script:Config.Findings
            }
            $jsonOutput|ConvertTo-Json -Depth 10|Out-File $JSONPath -Encoding UTF8
            Write-Log "JSON report saved: $JSONPath" -Level Success -Category 'Export'
        }catch{
            Write-Log "JSON export failed: $_" -Level Error -Category 'Export'
        }
    }
    
    if($SaveReport){
        Write-Log "Text report saved: $OutputPath" -Level Success -Category 'Export'
    }
    
    Write-Host "`n" -NoNewline
    if(-not $NoColor){
        Write-Host "═══════════════════════════════════════════════════════════════════" -ForegroundColor Green
        Write-Host "  RECOMMENDATIONS" -ForegroundColor Green
        Write-Host "═══════════════════════════════════════════════════════════════════" -ForegroundColor Green
        Write-Host "  1. Patch all systems immediately" -ForegroundColor Yellow
        Write-Host "  2. Review and remediate CRITICAL findings first" -ForegroundColor Yellow
        Write-Host "  3. Enable security features (Credential Guard, HVCI, LAPS)" -ForegroundColor Yellow
        Write-Host "  4. Implement least privilege principles" -ForegroundColor Yellow
        Write-Host "  5. Enable and configure EDR/logging" -ForegroundColor Yellow
        Write-Host "═══════════════════════════════════════════════════════════════════" -ForegroundColor Green
        Write-Host "  For authorized security assessments only!" -ForegroundColor Red
        Write-Host "═══════════════════════════════════════════════════════════════════`n" -ForegroundColor Green
    }
}

# ============================================================================
# MAIN ASSESSMENT ORCHESTRATION
# ============================================================================

function Start-Assessment{
    Clear-Host
    
    if(-not $NoColor){
        Write-Host @"

 ██╗    ██╗██╗███╗   ██╗██████╗ ██████╗ ██╗██╗   ██╗███████╗███████╗ ██████╗
 ██║    ██║██║████╗  ██║██╔══██╗██╔══██╗██║██║   ██║██╔════╝██╔════╝██╔════╝
 ██║ █╗ ██║██║██╔██╗ ██║██████╔╝██████╔╝██║██║   ██║█████╗  ███████╗██║     
 ██║███╗██║██║██║╚██╗██║██╔═══╝ ██╔══██╗██║╚██╗ ██╔╝██╔══╝  ╚════██║██║     
 ╚███╔███╔╝██║██║ ╚████║██║     ██║  ██║██║ ╚████╔╝ ███████╗███████║╚██████╗
  ╚══╝╚══╝ ╚═╝╚═╝  ╚═══╝╚═╝     ╚═╝  ╚═╝╚═╝  ╚═══╝  ╚══════╝╚══════╝ ╚═════╝
                                                                              
            COMPLETE Edition v4.0 - 100% Coverage
            200+ Checks | Modern OS Support | Full Enumeration
"@ -ForegroundColor Cyan
    }
    
    Write-Host "  Mode: $Mode | Threads: $Threads | Output: $(if($SaveReport){'Text+'}else{''})$(if($JSON){'JSON'}else{'Console'})" -ForegroundColor Gray
    Write-Host "  Started: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`n" -ForegroundColor Gray
    
    if($SaveReport){
        @"
═══════════════════════════════════════════════════════════════════
  WinPrivEsc Ultimate COMPLETE Assessment Report
═══════════════════════════════════════════════════════════════════
Generated: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
Host: $env:COMPUTERNAME
User: $env:USERNAME
Mode: $Mode
Version: $($script:Config.Version)
Coverage: 100% (200+ checks)
═══════════════════════════════════════════════════════════════════

"@|Out-File -FilePath $OutputPath -Encoding UTF8
    }
    
    # Execute all checks
    Get-SystemInformation
    Get-KernelMitigations
    Get-ProcessMitigations
    Get-AdvancedTokenAnalysis
    Test-ContainerEscapes
    Test-CloudMetadata
    Test-AlwaysInstallElevated
    Get-VulnerableServices
    Get-VulnerableScheduledTasks
    Test-KernelExploits
    Find-Credentials
    Find-BrowserCredentials
    Get-ClipboardAndRecent
    Test-CachedCredentials
    Test-ADCSVulnerabilities
    Test-NetworkVulnerabilities
    Test-PersistenceMechanisms
    Test-WMIPersistence
    Test-COMHijacking
    Find-DLLHijacking
    Test-UACBypass
    Get-VulnerableDrivers
    Get-SecurityProducts
    Test-PrintSpooler
    Get-ActiveDirectoryInfo
    Get-NamedPipes
    Test-AccessibilityFeatures
    Get-ShadowCopies
    Test-AppLocker
    Test-EnvironmentVariables
    Get-NetworkConfiguration
    Get-ProcessInfo
    Test-BitLocker
    Get-LOLBASBinaries
    Test-ModernWindowsFeatures
    Write-FinalReport
}

# ============================================================================
# SCRIPT ENTRY POINT
# ============================================================================

try{
    Start-Assessment
}catch{
    Write-Host "`n[FATAL ERROR] $($_.Exception.Message)" -ForegroundColor Red
    Write-Host $_.ScriptStackTrace -ForegroundColor Red
    exit 1
}finally{
    $ProgressPreference='Continue'
}
